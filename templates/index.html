<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìπ</text></svg>">
    <title>Blink Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Dark theme (default) */
        [data-theme="dark"]{--bg-deep:#0a0a0f;--bg-primary:#12121a;--bg-card:#1a1a24;--bg-hover:#242430;--border:#2a2a3a;--text:#f0f0f5;--text-muted:#7a7a8a;--accent:#6366f1;--accent-glow:rgba(99,102,241,0.3);--success:#10b981;--warning:#f59e0b;--error:#ef4444;--radius:12px;--radius-sm:8px;--sidebar-width:200px}
        /* Light theme */
        [data-theme="light"]{--bg-deep:#f5f5f7;--bg-primary:#ffffff;--bg-card:#ffffff;--bg-hover:#f0f0f2;--border:#e0e0e5;--text:#1a1a2e;--text-muted:#6b6b7a;--accent:#6366f1;--accent-glow:rgba(99,102,241,0.2);--success:#059669;--warning:#d97706;--error:#dc2626;--radius:12px;--radius-sm:8px;--sidebar-width:200px}
        *{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;overflow:hidden}body{font-family:'DM Sans',sans-serif;background:var(--bg-deep);color:var(--text)}
        .hidden{display:none!important}
        .loading-screen{min-height:100vh;display:flex;align-items:center;justify-content:center}.loading-screen.hidden{display:none}
        .login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}.login-screen.hidden{display:none}
        .login-card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:2.5rem;width:100%;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
        .login-logo{text-align:center;margin-bottom:2rem}.login-logo .icon{width:64px;height:64px;background:linear-gradient(135deg,var(--accent),#8b5cf6);border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-size:1.75rem;margin-bottom:1rem}.login-logo h1{font-size:1.5rem}.login-logo .version{font-size:0.75rem;color:var(--text-muted)}
        .form-group{margin-bottom:1.25rem}.form-group label{display:block;font-size:0.8rem;color:var(--text-muted);margin-bottom:0.5rem;text-transform:uppercase}
        input,select{width:100%;padding:0.75rem;background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:0.9rem}input:focus,select:focus{outline:none;border-color:var(--accent)}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.75rem 1.25rem;font-size:0.9rem;font-weight:600;border:none;border-radius:var(--radius-sm);cursor:pointer;transition:all 0.2s}.btn-primary{background:var(--accent);color:white}.btn-primary:hover{opacity:0.9}.btn-secondary{background:var(--bg-hover);color:var(--text);border:1px solid var(--border)}.btn-danger{background:var(--error);color:white}.btn-sm{padding:0.5rem 0.75rem;font-size:0.8rem}.btn-ghost{background:transparent;color:var(--text-muted);border:1px solid var(--border)}.btn-ghost:hover{background:var(--bg-hover);color:var(--text)}.btn:disabled{opacity:0.6;cursor:not-allowed}
        .switch input:checked + .slider{background:var(--success)}.switch .slider:before{position:absolute;content:"";height:18px;width:18px;left:2px;bottom:2px;background:white;border-radius:50%;transition:.3s}.switch input:checked + .slider:before{transform:translateX(20px)}
        .login-divider{display:flex;align-items:center;margin:1.5rem 0;color:var(--text-muted);font-size:0.8rem}.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border)}.login-divider span{padding:0 1rem}
        .pin-section{background:var(--bg-primary);border-radius:var(--radius-sm);padding:1.25rem;margin-bottom:1.25rem;border:1px solid var(--border)}.pin-section p{font-size:0.85rem;color:var(--text-muted);margin-bottom:1rem}.pin-row{display:flex;gap:0.75rem}.pin-row input{flex:1;text-align:center;font-size:1.25rem;letter-spacing:0.25em}
        .loading-spinner{display:none;text-align:center;padding:1rem}.loading-spinner.active{display:block}.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 0.75rem}@keyframes spin{to{transform:rotate(360deg)}}.loading-text{font-size:0.85rem;color:var(--text-muted)}
        .app-layout{display:none;height:100%;overflow:hidden}.app-layout.active{display:flex}
        .demo-banner{background:linear-gradient(90deg,var(--warning),#d97706);color:#000;padding:0.5rem;display:flex;align-items:center;justify-content:center;gap:1rem;font-size:0.85rem;font-weight:600;position:fixed;top:0;left:0;right:0;z-index:200}.demo-banner button{background:rgba(0,0,0,0.2);color:#000;border:none;padding:0.3rem 0.75rem;border-radius:4px;cursor:pointer}
        .sidebar{width:var(--sidebar-width);background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:100;transition:transform 0.3s}.sidebar.demo-active{top:36px;height:calc(100vh - 36px)}
        .sidebar-logo{padding:1rem;display:flex;align-items:center;gap:0.6rem;border-bottom:1px solid var(--border)}.sidebar-logo .icon{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),#8b5cf6);border-radius:8px;display:flex;align-items:center;justify-content:center}
        .sidebar-nav{flex:1;padding:0.75rem;display:flex;flex-direction:column;gap:0.25rem;overflow-y:auto}.nav-section{margin-top:1rem;padding-top:0.75rem;border-top:1px solid var(--border)}.nav-section:first-child{margin-top:0;padding-top:0;border-top:none}.nav-label{font-size:0.65rem;text-transform:uppercase;color:var(--text-muted);padding:0.5rem 0.75rem}
        .nav-item{display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.75rem;border-radius:var(--radius-sm);color:var(--text-muted);font-size:0.85rem;cursor:pointer;border:none;background:none;width:100%;text-align:left;transition:all 0.2s}.nav-item:hover{background:var(--bg-hover);color:var(--text)}.nav-item.active{background:var(--accent);color:white}.nav-item .icon{width:20px;text-align:center}
        .sidebar-footer{padding:0.75rem;border-top:1px solid var(--border)}.sidebar-status{display:flex;align-items:center;gap:0.4rem;font-size:0.75rem;color:var(--text-muted)}
        .status-dot{width:6px;height:6px;border-radius:50%;background:var(--text-muted)}.status-dot.online{background:var(--success)}.status-dot.demo{background:var(--warning)}.status-dot.syncing{background:var(--accent);animation:pulse 1.5s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .main-content{flex:1;margin-left:var(--sidebar-width);height:100%;display:flex;flex-direction:column;overflow:hidden;transition:margin 0.3s}.main-content.demo-active{margin-top:36px}
        .top-bar{background:var(--bg-card);border-bottom:1px solid var(--border);padding:0.75rem 1.25rem;display:flex;align-items:center;justify-content:space-between}.top-bar h2{font-size:1rem}.top-bar-actions{display:flex;gap:0.5rem}
        .icon-btn{width:36px;height:36px;border-radius:var(--radius-sm);background:var(--bg-hover);border:1px solid var(--border);color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}.icon-btn:hover{border-color:var(--accent)}
        .menu-btn{display:none}
        .content-area{flex:1;padding:1.25rem;overflow:hidden;display:flex;flex-direction:column;min-height:0}.tab-content{display:none;flex:1;overflow:hidden;min-height:0;flex-direction:column}.tab-content.active{display:flex}
        .tab-content-scroll{flex:1;overflow-y:auto;min-height:0;margin-top:0.5rem}.tab-content-scroll::-webkit-scrollbar{width:8px}.tab-content-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
        .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1.5rem}.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1rem}.stat-card .label{font-size:0.7rem;text-transform:uppercase;color:var(--text-muted)}.stat-card .value{font-size:1.5rem;font-weight:700}.stat-card .sub{font-size:0.75rem;color:var(--text-muted)}.stat-card.stat-clickable{cursor:pointer;transition:transform 0.15s,border-color 0.15s}.stat-card.stat-clickable:hover{transform:translateY(-2px);border-color:var(--accent)}
        .dash-panel{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;min-height:120px}.dash-panel .alert-item{display:flex;gap:0.75rem;padding:0.6rem;border-radius:var(--radius-sm);margin-bottom:0.5rem;background:var(--bg-primary)}.dash-panel .alert-item:last-child{margin-bottom:0}.dash-panel .alert-item.alert-success{background:rgba(16,185,129,0.1);border-left:3px solid #10b981}.dash-panel .alert-item.alert-warning{background:rgba(245,158,11,0.1);border-left:3px solid #f59e0b}.dash-panel .alert-item.alert-info{background:rgba(59,130,246,0.1);border-left:3px solid #3b82f6}.dash-panel .alert-icon{font-size:1.2rem}.dash-panel .alert-text{flex:1;font-size:0.85rem}.dash-panel .alert-sub{font-size:0.7rem;color:var(--text-muted)}.dash-panel .bar-row{display:flex;align-items:center;gap:0.5rem;margin:0.5rem 0}.dash-panel .bar-label{width:180px;font-size:0.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.dash-panel .bar-track{flex:1;height:12px;background:var(--bg-primary);border-radius:6px;overflow:hidden}.dash-panel .bar-fill{height:100%;border-radius:6px;background:linear-gradient(90deg,#3b82f6,#8b5cf6)}.dash-panel .bar-count{width:40px;text-align:right;font-size:0.75rem;color:var(--text-muted)}
        .signal-bars{display:inline-flex;gap:2px;align-items:flex-end;height:14px}.signal-bars .bar{width:4px;background:var(--border);border-radius:1px}.signal-bars .bar.active{background:#10b981}.signal-bars .bar:nth-child(1){height:4px}.signal-bars .bar:nth-child(2){height:7px}.signal-bars .bar:nth-child(3){height:10px}.signal-bars .bar:nth-child(4){height:14px}
        .health-grid{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:1rem}.health-dot{width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:600;cursor:pointer;transition:transform 0.15s;position:relative}.health-dot:hover{transform:scale(1.15)}.health-dot.good{background:linear-gradient(135deg,#10b981,#059669);color:white}.health-dot.warn{background:linear-gradient(135deg,#f59e0b,#d97706);color:white}.health-dot.bad{background:linear-gradient(135deg,#ef4444,#dc2626);color:white}
        .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;flex-wrap:wrap;gap:0.5rem}.section-header h3{font-size:0.85rem;color:var(--text-muted);text-transform:uppercase}
        .camera-grid,.sync-modules,.video-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem}
        .camera-card,.sync-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:all 0.2s}.camera-card:hover,.sync-card:hover{border-color:var(--accent);transform:translateY(-2px)}
        .camera-card.camera-offline{border-color:var(--danger);opacity:0.8}.camera-card.camera-offline:hover{border-color:var(--danger)}
        .camera-card .thumb{aspect-ratio:16/9;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;position:relative}.camera-card .thumb img{width:100%;height:100%;object-fit:cover}.camera-card .thumb .placeholder{font-size:2rem;color:var(--text-muted)}.camera-card .thumb .thumb-time{position:absolute;bottom:4px;right:4px;background:rgba(0,0,0,0.75);color:#fff;padding:2px 6px;border-radius:4px;font-size:0.65rem}
        .camera-card .thumb-actions{position:absolute;top:4px;right:4px;display:flex;gap:4px;opacity:0;transition:opacity 0.2s}.camera-card:hover .thumb-actions{opacity:1}.thumb-btn{width:28px;height:28px;border-radius:6px;border:none;background:rgba(0,0,0,0.7);color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.9rem}.thumb-btn:hover{background:var(--accent)}
        .camera-card .info{padding:0.75rem}.camera-card .name{font-weight:600;font-size:0.9rem;display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap}.camera-card .meta{font-size:0.7rem;color:var(--text-muted);display:flex;gap:0.5rem;margin-top:0.25rem;flex-wrap:wrap;align-items:center}
        .sync-card{padding:1rem}.sync-card .header{display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem}.sync-card .icon{font-size:1.5rem}.sync-card .name{font-weight:600}.sync-card .status{font-size:0.75rem;color:var(--text-muted)}.sync-card .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem;font-size:0.75rem}.sync-card .stat{padding:0.5rem;background:var(--bg-primary);border-radius:var(--radius-sm)}.sync-card .stat-label{color:var(--text-muted);font-size:0.65rem;text-transform:uppercase}
        .badge{display:inline-flex;padding:0.15rem 0.4rem;border-radius:4px;font-size:0.6rem;font-weight:600;text-transform:uppercase}.badge-success{background:rgba(16,185,129,0.2);color:var(--success)}.badge-warning{background:rgba(245,158,11,0.2);color:var(--warning)}
        .filter-bar{display:flex;gap:0.75rem;flex-wrap:wrap;align-items:center;padding:1rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:1rem}.filter-bar label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-right:0.25rem}.filter-bar input,.filter-bar select{padding:0.5rem;font-size:0.8rem;max-width:140px}.filter-group{display:flex;align-items:center;gap:0.25rem}
        .quick-filters{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.75rem}.quick-filter{padding:0.4rem 0.75rem;background:var(--bg-hover);border:1px solid var(--border);border-radius:999px;font-size:0.75rem;cursor:pointer;color:var(--text)}.quick-filter:hover{background:var(--accent);border-color:var(--accent);color:#fff}.quick-filter.active{background:var(--accent);border-color:var(--accent);color:#fff}
        .video-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}.video-card{position:relative;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;cursor:pointer}.video-card:hover{border-color:var(--accent)}.video-card .thumb{aspect-ratio:16/9;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;position:relative}.video-card .thumb img{width:100%;height:100%;object-fit:cover}.video-card .thumb.no-thumb img{display:none}.video-card .thumb.no-thumb .thumb-placeholder{display:flex!important}.video-card .thumb .play-icon{position:absolute;font-size:1.5rem;color:white;text-shadow:0 2px 8px rgba(0,0,0,0.5)}.video-card .thumb .duration{position:absolute;bottom:4px;right:4px;background:rgba(0,0,0,0.75);padding:2px 6px;border-radius:4px;font-size:0.6rem}.video-card .info{padding:0.5rem}.video-card .camera{font-size:0.75rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.video-card .time{font-size:0.65rem;color:var(--text-muted)}.video-card .star{position:absolute;top:4px;right:4px;font-size:0.9rem;cursor:pointer;opacity:0.5}.video-card .star.active{opacity:1}.video-card.selected{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}.video-card .select-check{position:absolute;top:4px;left:4px;width:16px;height:16px;background:rgba(0,0,0,0.5);border:2px solid white;border-radius:4px;display:none;align-items:center;justify-content:center;color:white;font-size:0.6rem}.video-card:hover .select-check,.video-card.selected .select-check{display:flex}.video-card.selected .select-check{background:var(--accent);border-color:var(--accent)}
        .bulk-actions{display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1rem;background:var(--accent);border-radius:var(--radius);margin-bottom:1rem;color:white}.bulk-actions .count{font-weight:600}
        .pagination{display:flex;align-items:center;justify-content:center;gap:0.5rem;margin-top:1rem}.pagination button{padding:0.5rem 1rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);cursor:pointer}.pagination button:disabled{opacity:0.5}.page-info{font-size:0.85rem;color:var(--text-muted)}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:300;padding:1rem}.modal-overlay.active{display:flex}.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);max-width:700px;width:100%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}.modal.modal-lg{max-width:1000px}.modal.modal-xl{max-width:1200px}.modal-header{padding:1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}.modal-close{background:none;border:none;font-size:1.25rem;cursor:pointer;color:var(--text-muted)}.modal-body{padding:1.25rem;overflow-y:auto;flex:1}.modal-footer{padding:1rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:0.75rem}
        .video-player{width:100%;border-radius:var(--radius-sm);background:#000}.video-details{display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin-top:1rem}.video-detail-item{padding:0.6rem;background:var(--bg-primary);border-radius:var(--radius-sm)}.video-detail-item .label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase}.video-detail-item .value{font-weight:600;font-size:0.9rem}
        .tag-manager{display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem}.tag-pill{display:inline-flex;align-items:center;gap:0.25rem;padding:0.25rem 0.5rem;border-radius:999px;font-size:0.7rem;cursor:pointer}.add-tag-btn{background:var(--bg-hover);border:1px dashed var(--border);color:var(--text-muted)}
        .empty-state{text-align:center;padding:3rem;color:var(--text-muted)}.empty-state .icon{font-size:3rem;margin-bottom:1rem}
        .download-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem}
        .log-viewer{background:#0d1117;border:1px solid var(--border);border-radius:var(--radius);height:calc(100vh - 280px);min-height:400px;overflow-y:auto;font-family:'Consolas','Monaco','Courier New',monospace;font-size:0.75rem;padding:0.5rem}.log-viewer::-webkit-scrollbar{width:8px}.log-viewer::-webkit-scrollbar-thumb{background:#30363d;border-radius:4px}.log-entry{padding:3px 8px;border-radius:3px;margin:1px 0;white-space:pre-wrap;word-break:break-all}.log-entry.INFO{color:#58a6ff}.log-entry.WARNING{color:#d29922;background:rgba(210,153,34,0.1)}.log-entry.ERROR{color:#f85149;background:rgba(248,81,73,0.1)}.log-entry.DEBUG{color:#8b949e}.log-entry .timestamp{color:#6e7681}.log-entry .level{font-weight:600;display:inline-block;width:55px}.log-empty{color:#6e7681;text-align:center;padding:2rem}
        [data-theme="light"] .log-viewer{background:#f6f8fa;border-color:var(--border)}[data-theme="light"] .log-entry.INFO{color:#0550ae}[data-theme="light"] .log-entry.WARNING{color:#9a6700}[data-theme="light"] .log-entry.ERROR{color:#cf222e}
        .settings-grid{display:grid;gap:1.5rem}.settings-section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem}.settings-section h3{font-size:0.9rem;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem}.setting-row{display:flex;align-items:center;justify-content:space-between;padding:0.6rem 0;border-bottom:1px solid var(--border)}.setting-row:last-child{border-bottom:none}.setting-label{font-size:0.85rem}.setting-desc{font-size:0.7rem;color:var(--text-muted)}
        .settings-accordion{display:flex;flex-direction:column;gap:0.5rem;max-width:600px}.settings-group{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}.settings-group[open]{border-color:var(--accent)}.settings-group-header{display:flex;align-items:center;gap:0.5rem;padding:0.875rem 1rem;cursor:pointer;font-weight:600;font-size:0.9rem;list-style:none;background:var(--bg-card);transition:background 0.2s}.settings-group-header:hover{background:var(--bg-hover)}.settings-group-header::before{content:'‚ñ∂';font-size:0.6rem;color:var(--text-muted);transition:transform 0.2s}.settings-group[open] .settings-group-header::before{transform:rotate(90deg)}.settings-group-header::-webkit-details-marker{display:none}.settings-group-content{padding:0 1rem 1rem 1rem;border-top:1px solid var(--border)}
        .toggle{width:44px;height:24px;background:var(--bg-hover);border-radius:999px;position:relative;cursor:pointer;border:none;transition:background 0.2s}.toggle.active{background:var(--accent)}.toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:white;border-radius:50%;transition:left 0.2s}.toggle.active::after{left:22px}
        .toast-container{position:fixed;bottom:1rem;right:1rem;z-index:400;display:flex;flex-direction:column;gap:0.5rem}.toast{padding:0.75rem 1rem;border-radius:var(--radius-sm);background:var(--bg-card);border:1px solid var(--border);font-size:0.85rem;animation:slideIn 0.3s}.toast-success{border-color:var(--success)}.toast-error{border-color:var(--error)}.toast-info{border-color:var(--accent)}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .progress-bar{height:6px;background:var(--bg-hover);border-radius:3px;overflow:hidden;margin-top:0.5rem}.progress-bar .fill{height:100%;background:var(--accent);transition:width 0.3s}
        .theme-toggle{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;background:var(--bg-hover);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;font-size:0.8rem;color:var(--text)}
        /* Calendar View */
        .calendar-bar{display:flex;align-items:center;gap:1rem;padding:0.75rem 1rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:0.75rem}
        .calendar-nav{display:flex;align-items:center;gap:0.5rem}.calendar-nav button{width:28px;height:28px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-hover);color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.8rem}.calendar-nav button:hover{border-color:var(--accent)}.calendar-month{font-weight:600;min-width:120px;text-align:center}
        .calendar-days{display:flex;gap:3px;flex-wrap:wrap;flex:1;justify-content:flex-start}.calendar-day{width:32px;height:32px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg-primary);display:flex;align-items:center;justify-content:center;font-size:0.7rem;cursor:pointer;position:relative;color:var(--text-muted)}.calendar-day:hover{border-color:var(--accent)}.calendar-day.has-videos{background:var(--bg-hover);color:var(--text);font-weight:600}.calendar-day.selected{background:var(--accent);color:white;border-color:var(--accent)}.calendar-day.today{border-color:var(--success)}.calendar-day .dot{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--accent)}.calendar-day.selected .dot{background:white}
        /* Playback Controls */
        .playback-controls{display:flex;align-items:center;gap:0.75rem;margin-top:0.75rem;padding:0.5rem 0}.speed-controls{display:flex;gap:0.25rem}.speed-btn{padding:0.35rem 0.6rem;font-size:0.7rem;border-radius:4px;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-muted);cursor:pointer}.speed-btn:hover{border-color:var(--accent);color:var(--text)}.speed-btn.active{background:var(--accent);color:white;border-color:var(--accent)}.pip-btn{margin-left:auto}
        /* Video Notes */
        .video-notes{margin-top:1rem}.video-notes textarea{width:100%;min-height:60px;padding:0.75rem;background:var(--bg-primary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.85rem;resize:vertical}.video-notes textarea:focus{outline:none;border-color:var(--accent)}.video-notes textarea::placeholder{color:var(--text-muted)}
        /* Keyboard hint */
        .keyboard-hint{font-size:0.65rem;color:var(--text-muted);margin-left:auto;display:flex;gap:0.75rem}.kbd{display:inline-block;padding:0.15rem 0.4rem;background:var(--bg-primary);border:1px solid var(--border);border-radius:3px;font-family:monospace;font-size:0.65rem}
        /* Mobile Responsive */
        @media(max-width:768px){
            .sidebar{transform:translateX(-100%);width:250px}.sidebar.open{transform:translateX(0)}
            .main-content{margin-left:0}
            .menu-btn{display:flex}
            .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}.sidebar-overlay.open{display:block}
            .top-bar h2{font-size:0.9rem}
            .stats-row{grid-template-columns:repeat(2,1fr)}
            .camera-grid,.video-grid{grid-template-columns:repeat(2,1fr)}
            .filter-bar{flex-direction:column;align-items:stretch}.filter-bar input,.filter-bar select{max-width:100%}
            .modal{margin:0.5rem;max-height:95vh}.modal.modal-lg,.modal.modal-xl{max-width:100%}
            .video-details{grid-template-columns:1fr}
            .content-area{padding:0.75rem}
        }
        @media(max-width:480px){
            .camera-grid,.video-grid{grid-template-columns:1fr}
            .stats-row{grid-template-columns:1fr}
            .top-bar-actions{gap:0.25rem}
            .icon-btn{width:32px;height:32px}
        }
    </style>
</head>
<body>
    <!-- Initial loading screen - shown while checking auth status -->
    <div class="loading-screen" id="loading-screen">
        <div style="text-align:center">
            <div style="font-size:3rem;margin-bottom:1rem">üìπ</div>
            <div class="spinner" style="margin:0 auto 1rem"></div>
            <div style="color:var(--text-muted)">Loading...</div>
        </div>
    </div>
    <div class="login-screen hidden" id="login-screen">
        <div class="login-card">
            <div class="login-logo"><div class="icon">üìπ</div><h1>Blink Hub</h1><p class="version" id="app-version" style="font-size:0.7rem;opacity:0.6">v3.1.0</p></div>
            <div id="login-form">
                <div class="form-group"><label>Email</label><input type="email" id="email" placeholder="your@email.com"></div>
                <div class="form-group"><label>Password</label><input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <div class="form-group" style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem">
                    <input type="checkbox" id="remember-me" checked style="width:auto;margin:0">
                    <label for="remember-me" style="margin:0;font-size:0.85rem;cursor:pointer">Remember me (save credentials)</label>
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="login()">Sign In</button>
                <div class="login-divider"><span>or</span></div>
                <button class="btn btn-secondary" style="width:100%" onclick="loginSaved()">Use Saved Credentials</button>
                <button class="btn btn-ghost" style="width:100%;margin-top:0.75rem" onclick="enterDemoMode()">üëÅ Preview Demo</button>
            </div>
            <div id="pin-form" class="hidden">
                <div class="pin-section"><p>üì± Enter the PIN sent to your phone via SMS</p><div class="pin-row"><input type="text" id="pin" placeholder="000000" maxlength="6"><button class="btn btn-primary" onclick="verifyPin()" id="verify-btn">Verify</button></div></div>
                <div class="loading-spinner" id="login-loading"><div class="spinner"></div><div class="loading-text">Connecting to Blink servers...</div></div>
                <button class="btn btn-secondary" style="width:100%" onclick="resendPin()">üîÑ Resend PIN</button>
                <button class="btn btn-ghost" style="width:100%;margin-top:0.5rem" onclick="backToLogin()">‚Üê Back to Login</button>
            </div>
        </div>
    </div>
    <div class="demo-banner hidden" id="demo-banner"><span>‚ö† Demo Mode - Preview Only</span><button onclick="exitDemoMode()">Exit Demo</button></div>
    <div class="app-layout" id="app-layout">
        <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo"><div class="icon">üìπ</div><span style="font-weight:600">Blink</span></div>
            <nav class="sidebar-nav">
                <div class="nav-section"><div class="nav-label">Monitor</div>
                    <button class="nav-item active" onclick="switchTab('dashboard')"><span class="icon">üìä</span>Dashboard</button>
                    <button class="nav-item" onclick="switchTab('cameras')"><span class="icon">üì∑</span>Cameras</button>
                    <button class="nav-item" onclick="switchTab('sync')"><span class="icon">üì°</span>Sync Modules</button>
                    <button class="nav-item" onclick="switchTab('videos')"><span class="icon">üé¨</span>Videos</button>
                </div>
                <div class="nav-section"><div class="nav-label">Tools</div>
                    <button class="nav-item" onclick="switchTab('downloads')"><span class="icon">üì•</span>Downloads</button>
                    <button class="nav-item" onclick="switchTab('logs')"><span class="icon">üìã</span>Logs</button>
                    <button class="nav-item" onclick="switchTab('settings')"><span class="icon">‚öô</span>Settings</button>
                </div>
            </nav>
            <div class="sidebar-footer"><div class="sidebar-status"><span class="status-dot" id="status-dot"></span><span id="status-text">Connecting...</span></div><div id="sidebar-version" style="font-size:0.65rem;color:var(--text-muted);margin-top:0.25rem"></div></div>
        </aside>
        <main class="main-content" id="main-content">
            <div class="top-bar"><button class="icon-btn menu-btn" onclick="toggleMobileMenu()" title="Menu">‚ò∞</button><h2 id="page-title">Dashboard</h2><div class="top-bar-actions"><button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme"><span id="theme-icon">üåô</span></button><button class="icon-btn" onclick="refreshAll()" title="Refresh">üîÑ</button><button class="icon-btn" onclick="openFolder()" title="Open Folder">üìÅ</button><button class="icon-btn" onclick="logout()" title="Logout">üö™</button></div></div>
            <div class="content-area">
                <!-- Dashboard Tab -->
                <div class="tab-content active" id="tab-dashboard">
                    <div class="tab-content-scroll">
                        <div class="stats-row">
                            <div class="stat-card stat-clickable" style="border-left:3px solid #3b82f6" onclick="openDashModal('cameras')"><div class="label">Cameras</div><div class="value" id="stat-cameras">0</div><div class="sub">Connected</div></div>
                            <div class="stat-card stat-clickable" style="border-left:3px solid #10b981" onclick="openDashModal('videos')"><div class="label">Local Videos</div><div class="value" id="stat-videos">0</div><div class="sub" id="stat-storage">0 MB</div></div>
                            <div class="stat-card stat-clickable" style="border-left:3px solid #f59e0b" onclick="openDashModal('today')"><div class="label">Today</div><div class="value" id="stat-today">0</div><div class="sub">Downloaded</div></div>
                            <div class="stat-card stat-clickable" style="border-left:3px solid #8b5cf6" onclick="openDashModal('disk')"><div class="label">Disk Free</div><div class="value" id="stat-disk">--</div><div class="sub" id="stat-disk-pct">--</div></div>
                            <div class="stat-card stat-clickable" style="border-left:3px solid #ec4899" onclick="openDashModal('cloud')"><div class="label">Cloud Sync</div><div class="value" id="stat-cloud">--</div><div class="sub" id="stat-cloud-sub">Check status</div></div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem">
                            <!-- Left Column -->
                            <div>
                                <div class="section-header"><h3>üì∑ Camera Health</h3></div>
                                <div id="dash-camera-health" class="dash-panel"><p style="color:var(--text-muted);font-size:0.85rem">Loading...</p></div>
                                
                                <div class="section-header" style="margin-top:1.5rem">
                                    <h3>üìä Most Active Cameras</h3>
                                    <select id="dash-active-days" onchange="updateActiveChart()" style="padding:0.3rem 0.5rem;font-size:0.75rem;border-radius:4px;background:var(--bg-primary);border:1px solid var(--border);color:var(--text)">
                                        <option value="1">Today</option>
                                        <option value="7" selected>Last 7 days</option>
                                        <option value="14">Last 14 days</option>
                                        <option value="30">Last 30 days</option>
                                    </select>
                                </div>
                                <div id="dash-active-cameras" class="dash-panel"><p style="color:var(--text-muted);font-size:0.85rem">Loading...</p></div>
                            </div>
                            <!-- Right Column -->
                            <div>
                                <div class="section-header"><h3>‚è∞ Schedule Status</h3></div>
                                <div id="dash-schedule" class="dash-panel"><p style="color:var(--text-muted);font-size:0.85rem">Loading...</p></div>
                                
                                <div class="section-header" style="margin-top:1.5rem"><h3>üì• Recent Downloads</h3><span style="font-size:0.7rem;color:var(--text-muted)">Updated: <span id="last-refresh">--</span></span></div>
                                <div id="dash-recent" class="dash-panel"><p style="color:var(--text-muted);font-size:0.85rem">Loading...</p></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Sync Modules Tab -->
                <div class="tab-content" id="tab-sync">
                    <div class="section-header" style="flex-wrap:wrap;gap:0.75rem">
                        <h3>All Sync Modules</h3>
                        <div style="display:flex;gap:0.5rem;align-items:center">
                            <span style="font-size:0.8rem;color:var(--text-muted)">Grid:</span>
                            <select id="sync-grid-size" onchange="updateSyncGridSize()" style="padding:0.4rem;font-size:0.8rem">
                                <option value="2">2 per row</option>
                                <option value="3">3 per row</option>
                                <option value="4" selected>4 per row</option>
                                <option value="5">5 per row</option>
                                <option value="6">6 per row</option>
                                <option value="7">7 per row</option>
                                <option value="8">8 per row</option>
                                <option value="9">9 per row</option>
                                <option value="10">10 per row</option>
                            </select>
                            <button class="btn btn-sm btn-secondary" onclick="refreshAll()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div class="sync-modules" id="sync-grid"><div class="empty-state"><div class="icon">üì°</div><p>Loading sync modules...</p></div></div>
                </div>
                <!-- Cameras Tab -->
                <div class="tab-content" id="tab-cameras">
                    <div class="filter-bar">
                        <div class="filter-group"><label>Group</label><select id="cam-group-filter" onchange="filterCameras()"><option value="">All Groups</option></select></div>
                        <div class="filter-group"><label>Grid</label><select id="cam-grid-size" onchange="updateGridSize()"><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6" selected>6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select></div>
                        <button class="btn btn-sm btn-secondary" onclick="loadCameras()">üîÑ Refresh</button>
                        <button class="btn btn-sm btn-secondary" onclick="refreshAllThumbnails()">üì∏ Refresh Thumbnails</button>
                    </div>
                    <div class="tab-content-scroll">
                        <div class="camera-grid" id="camera-grid"><div class="empty-state"><div class="icon">üì∑</div><p>Loading cameras...</p></div></div>
                    </div>
                </div>
                <!-- Videos Tab -->
                <div class="tab-content" id="tab-videos">
                    <div class="filter-bar">
                        <div class="filter-group"><label>Camera</label><select id="vid-camera" onchange="loadVideos()"><option value="">All Cameras</option></select></div>
                        <div class="filter-group"><label>Group</label><select id="vid-group" onchange="loadVideos()"><option value="">All Groups</option></select></div>
                        <div class="filter-group"><label>From</label><input type="date" id="vid-date-from" onchange="loadVideos()"></div>
                        <div class="filter-group"><label>To</label><input type="date" id="vid-date-to" onchange="loadVideos()"></div>
                        <div class="filter-group"><label>Tag</label><select id="vid-tag" onchange="loadVideos()"><option value="">All Tags</option></select></div>
                        <div class="filter-group"><label>Grid</label><select id="vid-grid-size" onchange="updateVideoGridSize()"><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6" selected>6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select></div>
                        <button class="btn btn-sm btn-secondary" onclick="clearFilters()">Clear</button>
                        <span class="keyboard-hint"><span><kbd>‚Üê</kbd><kbd>‚Üí</kbd> navigate</span><span><kbd>Space</kbd> play</span></span>
                    </div>
                    <div class="calendar-bar" id="calendar-bar">
                        <div class="calendar-nav">
                            <button onclick="calendarPrev()" title="Previous month">‚óÄ</button>
                            <span class="calendar-month" id="calendar-month">December 2025</span>
                            <button onclick="calendarNext()" title="Next month">‚ñ∂</button>
                        </div>
                        <div class="calendar-days" id="calendar-days"></div>
                    </div>
                    <div class="quick-filters">
                        <button class="quick-filter" onclick="quickFilter('today', event)">Today</button>
                        <button class="quick-filter" onclick="quickFilter('yesterday', event)">Yesterday</button>
                        <button class="quick-filter" onclick="quickFilter('week', event)">Last 7 Days</button>
                        <button class="quick-filter" onclick="quickFilter('starred', event)">‚≠ê Starred</button>
                    </div>
                    <div id="bulk-actions" class="bulk-actions hidden">
                        <span class="count"><span id="selected-count">0</span> selected</span>
                        <button class="btn btn-sm btn-secondary" onclick="bulkTagVideos()">üè∑ Tag</button>
                        <button class="btn btn-sm btn-secondary" onclick="bulkExportVideos()">üì¶ Export Zip</button>
                        <button class="btn btn-sm btn-danger" onclick="bulkDeleteVideos()">üóë Delete</button>
                        <button class="btn btn-sm btn-ghost" onclick="clearSelection()">‚úï Clear</button>
                    </div>
                    <div id="download-status-banner" class="hidden" style="background:var(--accent);color:white;padding:0.75rem 1rem;border-radius:var(--radius);margin-bottom:1rem;display:flex;align-items:center;gap:1rem">
                        <div class="spinner" style="width:16px;height:16px;border-width:2px;border-color:rgba(255,255,255,0.3);border-top-color:white"></div>
                        <div style="flex:1">
                            <div style="font-weight:600">Downloading videos...</div>
                            <div style="font-size:0.8rem;opacity:0.9" id="download-status-text">0 of 0</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:1.25rem;font-weight:700" id="download-status-percent">0%</div>
                        </div>
                    </div>
                    <div class="tab-content-scroll">
                        <div class="video-grid" id="video-grid"><div class="empty-state"><div class="icon">üé¨</div><p>No videos found</p></div></div>
                        <div class="pagination" id="video-pagination"></div>
                    </div>
                </div>
                <!-- Downloads Tab -->
                <div class="tab-content" id="tab-downloads">
                    <div class="download-card">
                        <h3 style="margin-bottom:1rem">üì• Download Videos</h3>
                        <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
                            <div class="form-group" style="margin:0"><label>Days Back</label><input type="number" id="dl-days" value="7" min="1" max="30" style="width:80px"></div>
                            <button class="btn btn-primary" id="dl-btn" onclick="startDownload()">Download Now</button>
                        </div>
                        <div id="dl-progress" class="hidden" style="margin-top:1rem;padding:1rem;background:var(--bg-primary);border-radius:var(--radius-sm)">
                            <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem"><span id="dl-status">Preparing...</span><span id="dl-count">0/0</span></div>
                            <div class="progress-bar"><div class="fill" id="dl-bar" style="width:0%"></div></div>
                            <div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem" id="dl-current"></div>
                        </div>
                    </div>
                    <div class="download-card" style="margin-top:1rem">
                        <h3 style="margin-bottom:1rem">üìú Recent Downloads</h3>
                        <div id="dl-history"><p style="color:var(--text-muted)">No download history</p></div>
                    </div>
                </div>
                <!-- Logs Tab -->
                <div class="tab-content" id="tab-logs">
                    <div class="section-header" style="margin-bottom:1rem">
                        <h3>üìã Live Logs</h3>
                        <div style="display:flex;gap:0.5rem;align-items:center">
                            <select id="log-level-filter" onchange="loadLogs()" style="padding:0.4rem;font-size:0.8rem">
                                <option value="">All Levels</option>
                                <option value="INFO">Info</option>
                                <option value="WARNING">Warning</option>
                                <option value="ERROR">Error</option>
                            </select>
                            <button class="btn btn-sm btn-secondary" onclick="loadLogs()">üîÑ Refresh</button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleAutoRefresh()" id="auto-refresh-btn">‚ñ∂ Auto</button>
                            <button class="btn btn-sm btn-ghost" onclick="clearLogs()">üóë Clear</button>
                        </div>
                    </div>
                    <div id="log-viewer" class="log-viewer">
                        <div class="log-empty">Loading logs...</div>
                    </div>
                    <div style="font-size:0.7rem;color:var(--text-muted);margin-top:0.5rem">
                        <span id="log-count">0</span> entries ‚Ä¢ Auto-refresh: <span id="auto-refresh-status">Off</span>
                    </div>
                </div>
                <!-- Settings Tab -->
                <div class="tab-content" id="tab-settings">
                    <div class="settings-accordion">
                        <!-- About -->
                        <details class="settings-group">
                            <summary class="settings-group-header">‚ÑπÔ∏è About</summary>
                            <div class="settings-group-content" style="text-align:center">
                                <div style="font-size:2.5rem;margin-bottom:0.5rem">üìπ</div>
                                <div style="font-size:1.25rem;font-weight:700;margin-bottom:0.25rem">Blink Hub</div>
                                <div style="color:var(--text-muted);margin-bottom:1rem" id="about-version">v3.1.0</div>
                                <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:1rem">
                                    A powerful tool to download and manage your Blink security camera videos locally.
                                </div>
                                <div style="display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;margin-bottom:1rem">
                                    <span class="badge badge-secondary">Python + FastAPI</span>
                                    <span class="badge badge-secondary">blinkpy</span>
                                    <span class="badge badge-secondary">SQLite</span>
                                </div>
                                <div style="font-size:0.75rem;color:var(--text-muted)">
                                    <div>Made with ‚ù§Ô∏è</div>
                                    <div style="margin-top:0.5rem" id="about-build-date"></div>
                                </div>
                            </div>
                        </details>
                        
                        <!-- Account -->
                        <details class="settings-group">
                            <summary class="settings-group-header">üîê Account</summary>
                            <div class="settings-group-content">
                                <div class="setting-row"><div><div class="setting-label">Forget Saved Credentials</div><div class="setting-desc">Clear stored login credentials - you'll need 2FA on next login</div></div><button class="btn btn-sm btn-danger" onclick="forgetCredentials()">üóë Forget</button></div>
                                <div class="setting-row"><div><div class="setting-label">Logout</div><div class="setting-desc">Sign out but keep saved credentials for quick re-login</div></div><button class="btn btn-sm btn-secondary" onclick="doLogout()">üö™ Logout</button></div>
                            </div>
                        </details>
                        
                        <!-- Automatic Sync -->
                        <details class="settings-group" open>
                            <summary class="settings-group-header">üîÑ Automatic Sync</summary>
                            <div class="settings-group-content">
                                <div class="setting-row"><div><div class="setting-label">Enable Auto-Sync</div><div class="setting-desc">Automatically download new videos</div></div><button class="toggle" id="toggle-sync" onclick="toggleSync()"></button></div>
                                <div class="setting-row"><div><div class="setting-label">Sync Interval</div></div><select id="sync-interval" style="width:120px" onchange="updateSyncInterval()"><option value="5">5 minutes</option><option value="15">15 minutes</option><option value="30">30 minutes</option><option value="60">1 hour</option></select></div>
                            </div>
                        </details>
                        
                        <!-- Cloud Sync -->
                        <details class="settings-group">
                            <summary class="settings-group-header">‚òÅÔ∏è Cloud Sync</summary>
                            <div class="settings-group-content">
                                <div class="setting-row"><div><div class="setting-label">Check Cloud Parity</div><div class="setting-desc">Verify local videos match what's in Blink cloud</div></div><button class="btn btn-sm btn-secondary" onclick="checkCloudParity()">üîç Check Now</button></div>
                                <div id="parity-results" style="margin-top:0.75rem;display:none"></div>
                            </div>
                        </details>
                        
                        <!-- Organization -->
                        <details class="settings-group">
                            <summary class="settings-group-header">üìÅ Organization</summary>
                            <div class="settings-group-content">
                                <div style="margin-bottom:1rem">
                                    <div class="setting-label" style="margin-bottom:0.5rem">Camera Groups</div>
                                    <div id="groups-list"><p style="color:var(--text-muted);font-size:0.85rem">No groups created</p></div>
                                    <button class="btn btn-sm btn-secondary" style="margin-top:0.5rem" onclick="openGroupModal()">+ New Group</button>
                                </div>
                                <div style="border-top:1px solid var(--border);padding-top:1rem">
                                    <div class="setting-label" style="margin-bottom:0.5rem">Video Tags</div>
                                    <div id="tags-list"><p style="color:var(--text-muted);font-size:0.85rem">No tags created</p></div>
                                    <button class="btn btn-sm btn-secondary" style="margin-top:0.5rem" onclick="openTagModal()">+ New Tag</button>
                                </div>
                            </div>
                        </details>
                        
                        <!-- Storage & Files -->
                        <details class="settings-group">
                            <summary class="settings-group-header">üíæ Storage & Files</summary>
                            <div class="settings-group-content">
                                <div class="setting-row"><div><div class="setting-label">Download Location</div><div class="setting-desc" id="storage-path">--</div></div><button class="btn btn-sm btn-secondary" onclick="browseFolder()">üìÇ Browse</button></div>
                                <div class="setting-row"><div><div class="setting-label">Video Thumbnails</div><div class="setting-desc">Generate missing thumbnails for downloaded videos</div></div><button class="btn btn-sm btn-secondary" onclick="regenerateThumbnails()">üñºÔ∏è Regenerate</button></div>
                            </div>
                        </details>
                        
                        <!-- Timezone -->
                        <details class="settings-group">
                            <summary class="settings-group-header">üïê Timezone</summary>
                            <div class="settings-group-content">
                                <div id="tz-warning" style="display:none; background:#ff943d22; border:1px solid #ff943d; border-radius:4px; padding:8px 12px; margin-bottom:10px; color:#ff943d;">
                                    ‚ö†Ô∏è Timezone support limited. Restart the application to install required timezone data.
                                </div>
                                <div class="setting-row">
                                    <div>
                                        <div class="setting-label">Video Filename Timezone</div>
                                        <div class="setting-desc">Timestamps in filenames will use this timezone</div>
                                    </div>
                                    <select id="timezone-select" style="width:200px" onchange="saveTimezone()">
                                        <option value="auto">Auto-detect from browser</option>
                                    </select>
                                </div>
                                <div class="setting-row">
                                    <div>
                                        <div class="setting-label">Rename Existing Videos</div>
                                        <div class="setting-desc" id="legacy-video-desc">Convert old UTC filenames to local time</div>
                                    </div>
                                    <button class="btn btn-sm btn-secondary" id="rename-videos-btn" onclick="renameVideosToLocalTime()">üîÑ Rename</button>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Video Modal -->
    <div class="modal-overlay" id="video-modal" onclick="if(event.target===this)closeModal('video-modal')">
        <div class="modal" style="max-width:800px">
            <div class="modal-header"><h3 id="video-title">Video</h3><button class="modal-close" onclick="closeModal('video-modal')">‚úï</button></div>
            <div class="modal-body">
                <video id="video-player" class="video-player" controls></video>
                <div class="playback-controls">
                    <span style="font-size:0.75rem;color:var(--text-muted)">Speed:</span>
                    <div class="speed-controls">
                        <button class="speed-btn" onclick="setPlaybackSpeed(0.5)">0.5x</button>
                        <button class="speed-btn active" onclick="setPlaybackSpeed(1)">1x</button>
                        <button class="speed-btn" onclick="setPlaybackSpeed(1.5)">1.5x</button>
                        <button class="speed-btn" onclick="setPlaybackSpeed(2)">2x</button>
                    </div>
                    <button class="btn btn-sm btn-ghost pip-btn" onclick="togglePiP()" title="Picture-in-Picture">üñº PiP</button>
                </div>
                <div class="video-details">
                    <div class="video-detail-item"><div class="label">Camera</div><div class="value" id="vid-camera-name">--</div></div>
                    <div class="video-detail-item"><div class="label">Date/Time</div><div class="value" id="vid-datetime">--</div></div>
                    <div class="video-detail-item"><div class="label">Duration</div><div class="value" id="vid-duration">--</div></div>
                    <div class="video-detail-item"><div class="label">Size</div><div class="value" id="vid-size">--</div></div>
                </div>
                <div class="video-notes">
                    <label class="setting-label" style="display:block;margin-bottom:0.5rem">Notes</label>
                    <textarea id="vid-notes" placeholder="Add notes about this video..." onchange="saveVideoNotes()"></textarea>
                </div>
                <div style="margin-top:1rem"><div class="setting-label">Tags</div><div class="tag-manager" id="vid-tags"></div></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="toggleStar()"><span id="star-text">‚òÜ Star</span></button>
                <button class="btn btn-secondary" onclick="markReviewed()">‚úì Reviewed</button>
                <a id="vid-download-link" class="btn btn-secondary" download>‚¨á Download</a>
                <button class="btn btn-danger" onclick="deleteVideo()">üóë Delete</button>
            </div>
        </div>
    </div>
    <!-- Camera Modal -->
    <div class="modal-overlay" id="camera-modal" onclick="if(event.target===this)closeModal('camera-modal')">
        <div class="modal modal-lg"><div class="modal-header"><h3 id="camera-title">Camera</h3><button class="modal-close" onclick="closeModal('camera-modal')">‚úï</button></div><div class="modal-body" id="camera-body"></div></div>
    </div>
    <!-- Sync Module Modal -->
    <div class="modal-overlay" id="sync-modal" onclick="if(event.target===this)closeModal('sync-modal')">
        <div class="modal"><div class="modal-header"><h3 id="sync-title">Sync Module</h3><button class="modal-close" onclick="closeModal('sync-modal')">‚úï</button></div><div class="modal-body" id="sync-body"></div></div>
    </div>
    <!-- Tag Modal -->
    <div class="modal-overlay" id="tag-modal" onclick="if(event.target===this)closeModal('tag-modal')">
        <div class="modal" style="max-width:400px">
            <div class="modal-header"><h3 id="tag-modal-title">New Tag</h3><button class="modal-close" onclick="closeModal('tag-modal')">‚úï</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Tag Name</label><input type="text" id="tag-name" placeholder="e.g., Package Delivery"></div>
                <div class="form-group"><label>Color</label><input type="color" id="tag-color" value="#3b82f6" style="height:40px"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('tag-modal')">Cancel</button><button class="btn btn-primary" onclick="saveTag()">Save</button></div>
        </div>
    </div>
    <!-- Group Modal -->
    <div class="modal-overlay" id="group-modal" onclick="if(event.target===this)closeModal('group-modal')">
        <div class="modal" style="max-width:500px">
            <div class="modal-header"><h3 id="group-modal-title">New Group</h3><button class="modal-close" onclick="closeModal('group-modal')">‚úï</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Group Name</label><input type="text" id="group-name" placeholder="e.g., Front of House"></div>
                <div class="form-group"><label>Color</label><input type="color" id="group-color" value="#6b7280" style="height:40px"></div>
                <div class="form-group"><label>Select Cameras</label><div id="group-cameras" style="max-height:200px;overflow-y:auto;background:var(--bg-primary);padding:0.75rem;border-radius:var(--radius-sm)"></div></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('group-modal')">Cancel</button><button class="btn btn-primary" onclick="saveGroup()">Save</button></div>
        </div>
    </div>
    <!-- Bulk Tag Modal -->
    <div class="modal-overlay" id="bulk-tag-modal" onclick="if(event.target===this)closeModal('bulk-tag-modal')">
        <div class="modal" style="max-width:400px">
            <div class="modal-header"><h3>Tag Selected Videos</h3><button class="modal-close" onclick="closeModal('bulk-tag-modal')">‚úï</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Select Tag</label><select id="bulk-tag-select" style="width:100%"></select></div>
                <p style="color:var(--text-muted);font-size:0.85rem">Apply tag to <strong id="bulk-count">0</strong> videos</p>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('bulk-tag-modal')">Cancel</button><button class="btn btn-primary" onclick="applyBulkTag()">Apply Tag</button></div>
        </div>
    </div>
    <!-- Add Tag to Video Modal -->
    <div class="modal-overlay" id="add-tag-modal" onclick="if(event.target===this)closeModal('add-tag-modal')">
        <div class="modal" style="max-width:400px">
            <div class="modal-header"><h3>Add Tag to Video</h3><button class="modal-close" onclick="closeModal('add-tag-modal')">‚úï</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Select Tag</label><select id="add-tag-select" style="width:100%"></select></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('add-tag-modal')">Cancel</button><button class="btn btn-primary" onclick="addTagToVideo()">Add Tag</button></div>
        </div>
    </div>
    <!-- Dashboard Info Modal -->
    <div class="modal-overlay" id="dash-modal" onclick="if(event.target===this)closeModal('dash-modal')">
        <div class="modal" style="max-width:500px">
            <div class="modal-header"><h3 id="dash-modal-title">Dashboard</h3><button class="modal-close" onclick="closeModal('dash-modal')">‚úï</button></div>
            <div class="modal-body" id="dash-modal-body"></div>
            <div class="modal-footer" id="dash-modal-footer"></div>
        </div>
    </div>
    <div class="toast-container" id="toasts"></div>
    <script>
// === State ===
let demoMode = false;
let cameras = [];
let syncModules = [];
let videos = [];
let tags = [];
let groups = [];
let selectedVideos = new Set();
let currentVideo = null;
let videoPage = 1;
let editingTagId = null;
let editingGroupId = null;
let downloadPollTimer = null;
let cameraGridSize = 6;
let syncGridSize = 4;
let videoGridSize = 6;
let cameraGroupFilter = '';
let cloudDownloadInterval = null;
let calendarDate = new Date();
let videoDayCounts = {};

// === Utilities ===
function toast(msg, type = 'info') {
    const t = document.createElement('div');
    t.className = 'toast toast-' + type;
    t.textContent = msg;
    document.getElementById('toasts').appendChild(t);
    setTimeout(() => t.remove(), 4000);
}

// Theme toggle
function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const newTheme = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    document.getElementById('theme-icon').textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}

// Load saved theme
(function() {
    const saved = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
})();

// Mobile menu
function toggleMobileMenu() {
    document.querySelector('.sidebar').classList.toggle('open');
    document.querySelector('.sidebar-overlay')?.classList.toggle('open');
}

// Close mobile menu when clicking nav item
document.addEventListener('click', (e) => {
    if (e.target.closest('.nav-item') && window.innerWidth <= 768) {
        document.querySelector('.sidebar').classList.remove('open');
        document.querySelector('.sidebar-overlay')?.classList.remove('open');
    }
});

function formatBytes(b) {
    if (!b) return '--';
    if (b < 1024) return b + ' B';
    if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
    if (b < 1073741824) return (b / 1048576).toFixed(1) + ' MB';
    return (b / 1073741824).toFixed(2) + ' GB';
}

function formatDuration(s) {
    if (!s) return '--';
    const m = Math.floor(s / 60), sec = s % 60;
    return m ? m + ':' + String(sec).padStart(2, '0') : '0:' + String(sec).padStart(2, '0');
}

function formatDateTime(dt) {
    if (!dt) return '--';
    try {
        const d = new Date(dt);
        return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    } catch (e) { return dt; }
}

function formatTime(dt) {
    if (!dt) return '';
    try {
        return new Date(dt).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    } catch (e) { return ''; }
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
    if (id === 'video-modal') {
        document.getElementById('video-player').src = '';
        currentVideo = null;
    }
    if (id === 'camera-modal') {
        stopLiveView();
    }
    if (id === 'dash-modal' && cloudDownloadInterval) {
        clearInterval(cloudDownloadInterval);
        cloudDownloadInterval = null;
    }
}

// Dashboard stat card modals
async function openDashModal(type) {
    const modal = document.getElementById('dash-modal');
    const title = document.getElementById('dash-modal-title');
    const body = document.getElementById('dash-modal-body');
    const footer = document.getElementById('dash-modal-footer');
    
    modal.classList.add('active');
    body.innerHTML = '<div style="text-align:center;padding:2rem"><div class="spinner"></div></div>';
    footer.innerHTML = '';
    
    if (type === 'cameras') {
        title.textContent = 'üì∑ Camera Overview';
        const online = cameras.filter(c => c.online_status === 'online' || c.online_status === 'unknown').length;
        const offline = cameras.filter(c => c.online_status === 'offline').length;
        const armed = cameras.filter(c => c.motion_enabled).length;
        
        body.innerHTML = '<div class="video-details">' +
            '<div class="video-detail-item"><div class="label">Total</div><div class="value">' + cameras.length + '</div></div>' +
            '<div class="video-detail-item"><div class="label">Online</div><div class="value" style="color:var(--success)">' + online + '</div></div>' +
            '<div class="video-detail-item"><div class="label">Offline</div><div class="value" style="color:' + (offline > 0 ? 'var(--danger)' : 'var(--text-muted)') + '">' + offline + '</div></div>' +
            '<div class="video-detail-item"><div class="label">Motion Armed</div><div class="value">' + armed + '</div></div>' +
            '</div>';
        if (offline > 0) {
            body.innerHTML += '<div style="margin-top:1rem;padding:0.75rem;background:rgba(239,68,68,0.1);border-radius:var(--radius-sm);border:1px solid var(--danger)">' +
                '<div style="font-weight:600;margin-bottom:0.5rem;color:var(--danger)">‚ö†Ô∏è Offline Cameras</div>' +
                '<div style="display:flex;flex-wrap:wrap;gap:0.25rem">' +
                cameras.filter(c => c.online_status === 'offline').map(c => 
                    '<span class="badge" style="background:var(--danger);color:white;cursor:pointer" onclick="closeModal(\'dash-modal\');openCameraModal(\'' + c.name + '\')">' + c.name + '</span>'
                ).join('') +
                '</div></div>';
        }
        footer.innerHTML = '<button class="btn btn-primary" onclick="closeModal(\'dash-modal\');switchTab(\'cameras\')">View All Cameras</button>';
        
    } else if (type === 'videos') {
        title.textContent = 'üé¨ Video Library';
        try {
            const r = await fetch('/api/status');
            const d = await r.json();
            const stats = d.stats || {};
            body.innerHTML = '<div class="video-details">' +
                '<div class="video-detail-item"><div class="label">Total Videos</div><div class="value">' + (stats.total_videos || 0) + '</div></div>' +
                '<div class="video-detail-item"><div class="label">Total Size</div><div class="value">' + (stats.total_size || '0 MB') + '</div></div>' +
                '<div class="video-detail-item"><div class="label">Starred</div><div class="value">' + (stats.starred_count || 0) + '</div></div>' +
                '<div class="video-detail-item"><div class="label">Unreviewed</div><div class="value">' + (stats.unreviewed_count || 0) + '</div></div>' +
                '</div>';
        } catch (e) {
            body.innerHTML = '<p style="color:var(--danger)">Error loading stats</p>';
        }
        footer.innerHTML = '<button class="btn btn-primary" onclick="closeModal(\'dash-modal\');switchTab(\'videos\')">Browse Videos</button>';
        
    } else if (type === 'today') {
        title.textContent = 'üìÖ Today\'s Activity';
        try {
            const r = await fetch('/api/status');
            const d = await r.json();
            const stats = d.stats || {};
            body.innerHTML = '<div class="video-details">' +
                '<div class="video-detail-item"><div class="label">Videos Today</div><div class="value">' + (stats.today_videos || 0) + '</div></div>' +
                '<div class="video-detail-item"><div class="label">Downloaded Today</div><div class="value">' + (stats.today_downloaded || stats.today_videos || 0) + '</div></div>' +
                '</div>' +
                '<p style="margin-top:1rem;color:var(--text-muted);font-size:0.85rem">Click below to view all videos from today.</p>';
        } catch (e) {
            body.innerHTML = '<p style="color:var(--danger)">Error loading stats</p>';
        }
        footer.innerHTML = '<button class="btn btn-primary" onclick="closeModal(\'dash-modal\');setTodayFilter()">View Today\'s Videos</button>';
        
    } else if (type === 'disk') {
        title.textContent = 'üíæ Storage Information';
        try {
            const r = await fetch('/api/status');
            const d = await r.json();
            const disk = d.disk || {};
            const pctUsed = disk.percent_used || 0;
            body.innerHTML = '<div class="video-details">' +
                '<div class="video-detail-item"><div class="label">Total Space</div><div class="value">' + (disk.total || '--') + '</div></div>' +
                '<div class="video-detail-item"><div class="label">Used</div><div class="value">' + (disk.used || '--') + '</div></div>' +
                '<div class="video-detail-item"><div class="label">Free</div><div class="value" style="color:var(--success)">' + (disk.free || '--') + '</div></div>' +
                '<div class="video-detail-item"><div class="label">Usage</div><div class="value">' + pctUsed + '%</div></div>' +
                '</div>' +
                '<div style="margin-top:1rem"><div style="background:var(--bg-primary);height:12px;border-radius:6px;overflow:hidden">' +
                '<div style="width:' + pctUsed + '%;height:100%;background:' + (pctUsed > 90 ? 'var(--danger)' : pctUsed > 75 ? 'var(--warning)' : 'var(--accent)') + ';border-radius:6px"></div>' +
                '</div></div>' +
                '<p style="margin-top:1rem;color:var(--text-muted);font-size:0.85rem">Download path: <code style="background:var(--bg-primary);padding:0.15rem 0.4rem;border-radius:4px;font-size:0.75rem">' + (d.download_path || '--') + '</code></p>';
        } catch (e) {
            body.innerHTML = '<p style="color:var(--danger)">Error loading disk info</p>';
        }
        footer.innerHTML = '<button class="btn btn-secondary" onclick="closeModal(\'dash-modal\');switchTab(\'settings\')">Change Location</button>';
        
    } else if (type === 'cloud') {
        title.textContent = '‚òÅÔ∏è Cloud Sync Status';
        body.innerHTML = '<div style="text-align:center;padding:2rem"><div class="spinner"></div><p style="margin-top:1rem;color:var(--text-muted)">Checking cloud parity...</p></div>';
        footer.innerHTML = '';
        
        try {
            const r = await fetch('/api/cloud-parity');
            const d = await r.json();
            
            if (d.error) {
                body.innerHTML = '<div style="color:var(--danger)">‚ö†Ô∏è ' + d.error + '</div>';
            } else {
                const cloudCount = d.cloud_count || 0;
                const localCount = d.local_count || 0;
                const missingCount = d.missing_count || 0;
                
                body.innerHTML = '<div class="video-details" style="grid-template-columns:repeat(3,1fr)">' +
                    '<div class="video-detail-item"><div class="label">In Cloud</div><div class="value" style="color:var(--accent)">' + cloudCount + '</div></div>' +
                    '<div class="video-detail-item"><div class="label">Downloaded</div><div class="value" style="color:var(--success)">' + localCount + '</div></div>' +
                    '<div class="video-detail-item"><div class="label">Missing</div><div class="value" style="color:' + (missingCount > 0 ? 'var(--warning)' : 'var(--success)') + '" id="cloud-missing-count">' + missingCount + '</div></div>' +
                    '</div>' +
                    '<div id="cloud-download-progress" style="margin-top:1rem"></div>';
                
                if (missingCount === 0) {
                    document.getElementById('cloud-download-progress').innerHTML = '<div style="text-align:center;color:var(--success);padding:1rem;background:rgba(16,185,129,0.1);border-radius:var(--radius-sm)">‚úÖ All cloud videos are downloaded locally!</div>';
                    // Update dashboard stat
                    document.getElementById('stat-cloud').textContent = '‚úì';
                    document.getElementById('stat-cloud-sub').textContent = 'All synced';
                } else {
                    document.getElementById('cloud-download-progress').innerHTML = '<div style="padding:1rem;background:rgba(245,158,11,0.1);border-radius:var(--radius-sm);border:1px solid var(--warning)">' +
                        '<div style="color:var(--warning);font-weight:600">‚ö†Ô∏è ' + missingCount + ' videos not yet downloaded</div>' +
                        '<p style="font-size:0.85rem;color:var(--text-muted);margin-top:0.5rem">Click below to download missing videos.</p></div>';
                    footer.innerHTML = '<button class="btn btn-primary" id="cloud-download-btn" onclick="startCloudDownload()">‚¨áÔ∏è Download Missing</button>';
                    // Update dashboard stat
                    document.getElementById('stat-cloud').textContent = missingCount;
                    document.getElementById('stat-cloud-sub').textContent = 'Missing';
                    document.getElementById('stat-cloud').style.color = 'var(--warning)';
                }
            }
        } catch (e) {
            body.innerHTML = '<div style="color:var(--danger)">‚ö†Ô∏è Error: ' + e.message + '</div>';
        }
    }
}

function setTodayFilter() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('vid-date-from').value = today;
    document.getElementById('vid-date-to').value = today;
    switchTab('videos');
}

async function startCloudDownload() {
    if (demoMode) { toast('Demo mode - downloads disabled', 'info'); return; }
    
    const btn = document.getElementById('cloud-download-btn');
    const progressEl = document.getElementById('cloud-download-progress');
    const footer = document.getElementById('dash-modal-footer');
    
    // Disable button and show starting state
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px;display:inline-block;margin-right:0.5rem"></div> Starting...';
    }
    
    try {
        const r = await fetch('/api/download-missing', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({browser_timezone: Intl.DateTimeFormat().resolvedOptions().timeZone})
        });
        const d = await r.json();
        
        if (r.ok && d.missing_count > 0) {
            // Show progress UI
            progressEl.innerHTML = 
                '<div style="padding:1rem;background:var(--bg-primary);border-radius:var(--radius-sm)">' +
                '<div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">' +
                '<span style="font-weight:600">Downloading...</span>' +
                '<span id="cloud-dl-count">0 / ' + d.missing_count + '</span>' +
                '</div>' +
                '<div class="progress-bar"><div class="fill" id="cloud-dl-bar" style="width:0%"></div></div>' +
                '<div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem" id="cloud-dl-current"></div>' +
                '</div>';
            footer.innerHTML = '<button class="btn btn-secondary" onclick="closeModal(\'dash-modal\')">Close</button>';
            
            // Start polling for progress
            cloudDownloadInterval = setInterval(pollCloudDownloadStatus, 1000);
        } else if (r.ok && d.missing_count === 0) {
            progressEl.innerHTML = '<div style="text-align:center;color:var(--success);padding:1rem;background:rgba(16,185,129,0.1);border-radius:var(--radius-sm)">‚úÖ All videos already downloaded!</div>';
            footer.innerHTML = '<button class="btn btn-secondary" onclick="closeModal(\'dash-modal\')">Close</button>';
        } else {
            progressEl.innerHTML = '<div style="color:var(--danger);padding:1rem">‚ö†Ô∏è ' + (d.detail || 'Error starting download') + '</div>';
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '‚¨áÔ∏è Retry Download';
            }
        }
    } catch (e) {
        progressEl.innerHTML = '<div style="color:var(--danger);padding:1rem">‚ö†Ô∏è Error: ' + e.message + '</div>';
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '‚¨áÔ∏è Retry Download';
        }
    }
}

async function pollCloudDownloadStatus() {
    try {
        const r = await fetch('/api/download-missing/status');
        const d = await r.json();
        
        const countEl = document.getElementById('cloud-dl-count');
        const barEl = document.getElementById('cloud-dl-bar');
        const currentEl = document.getElementById('cloud-dl-current');
        const progressEl = document.getElementById('cloud-download-progress');
        const missingEl = document.getElementById('cloud-missing-count');
        
        if (countEl && d.total > 0) {
            countEl.textContent = d.completed + ' / ' + d.total;
            const pct = Math.round((d.completed / d.total) * 100);
            if (barEl) barEl.style.width = pct + '%';
        }
        
        if (currentEl && d.current_video) {
            currentEl.textContent = d.current_video;
        }
        
        // Check if done
        if (!d.in_progress) {
            clearInterval(cloudDownloadInterval);
            cloudDownloadInterval = null;
            
            if (d.completed > 0) {
                progressEl.innerHTML = '<div style="text-align:center;color:var(--success);padding:1rem;background:rgba(16,185,129,0.1);border-radius:var(--radius-sm)">‚úÖ Downloaded ' + d.completed + ' videos!</div>';
                // Update dashboard stat
                document.getElementById('stat-cloud').textContent = '‚úì';
                document.getElementById('stat-cloud').style.color = 'var(--success)';
                document.getElementById('stat-cloud-sub').textContent = 'All synced';
                if (missingEl) missingEl.textContent = '0';
                // Refresh video list
                loadVideos();
            } else {
                progressEl.innerHTML = '<div style="text-align:center;padding:1rem;background:var(--bg-primary);border-radius:var(--radius-sm)">Download complete</div>';
            }
        }
    } catch (e) {
        console.error('Error polling download status:', e);
    }
}

async function downloadMissingFromDash() {
    // Legacy function - redirect to modal
    openDashModal('cloud');
}

// === Calendar ===
function renderCalendar() {
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('calendar-month').textContent = monthNames[month] + ' ' + year;
    
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
    
    const fromEl = document.getElementById('vid-date-from');
    const toEl = document.getElementById('vid-date-to');
    const selectedDate = fromEl.value === toEl.value ? fromEl.value : null;
    
    let html = '';
    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
        const count = videoDayCounts[dateStr] || 0;
        const isToday = dateStr === todayStr;
        const isSelected = dateStr === selectedDate;
        const hasVideos = count > 0;
        
        let classes = 'calendar-day';
        if (hasVideos) classes += ' has-videos';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';
        
        html += '<div class="' + classes + '" onclick="selectCalendarDay(\'' + dateStr + '\')" title="' + (count ? count + ' videos' : 'No videos') + '">' + 
            d + (hasVideos ? '<span class="dot"></span>' : '') + '</div>';
    }
    document.getElementById('calendar-days').innerHTML = html;
}

function calendarPrev() {
    calendarDate.setMonth(calendarDate.getMonth() - 1);
    loadVideoDayCounts();
}

function calendarNext() {
    calendarDate.setMonth(calendarDate.getMonth() + 1);
    loadVideoDayCounts();
}

function selectCalendarDay(dateStr) {
    document.getElementById('vid-date-from').value = dateStr;
    document.getElementById('vid-date-to').value = dateStr;
    document.querySelectorAll('.quick-filter').forEach(b => b.classList.remove('active'));
    loadVideos();
    renderCalendar();
}

async function loadVideoDayCounts() {
    if (demoMode) { renderCalendar(); return; }
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth() + 1;
    try {
        const r = await fetch('/api/local-videos/day-counts?year=' + year + '&month=' + month);
        const d = await r.json();
        videoDayCounts = d.counts || {};
    } catch (e) {
        videoDayCounts = {};
    }
    renderCalendar();
}

// === Playback Controls ===
function setPlaybackSpeed(speed) {
    const player = document.getElementById('video-player');
    player.playbackRate = speed;
    document.querySelectorAll('.speed-btn').forEach(b => {
        b.classList.toggle('active', b.textContent === speed + 'x');
    });
}

function togglePiP() {
    const player = document.getElementById('video-player');
    if (document.pictureInPictureElement) {
        document.exitPictureInPicture();
    } else if (player.requestPictureInPicture) {
        player.requestPictureInPicture().catch(e => toast('PiP not available', 'error'));
    } else {
        toast('Picture-in-Picture not supported', 'error');
    }
}

// === Video Notes ===
async function saveVideoNotes() {
    if (!currentVideo || demoMode) return;
    const notes = document.getElementById('vid-notes').value;
    try {
        await fetch('/api/local-videos/' + currentVideo.id + '/notes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notes: notes})
        });
        currentVideo.notes = notes;
        toast('Notes saved', 'success');
    } catch (e) {
        toast('Failed to save notes', 'error');
    }
}

// === Bulk Export ===
async function bulkExportVideos() {
    if (selectedVideos.size === 0) { toast('No videos selected', 'error'); return; }
    if (demoMode) { toast('Demo mode', 'info'); return; }
    
    toast('Preparing zip file...', 'info');
    try {
        const ids = Array.from(selectedVideos);
        const r = await fetch('/api/local-videos/export', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({video_ids: ids})
        });
        
        if (r.ok) {
            const blob = await r.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'blink-videos-' + new Date().toISOString().slice(0, 10) + '.zip';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            toast('Download started!', 'success');
            clearSelection();
        } else {
            const d = await r.json();
            toast(d.detail || 'Export failed', 'error');
        }
    } catch (e) {
        toast('Export failed: ' + e.message, 'error');
    }
}

// === Auth ===
async function login() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('password').value;
    if (!email || !pass) { toast('Enter email and password', 'error'); return; }
    
    // Store remember me preference for after 2FA
    window.rememberMe = document.getElementById('remember-me').checked;
    
    toast('Signing in...', 'info');
    try {
        const r = await fetch('/api/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email, password: pass, remember_me: window.rememberMe})
        });
        const d = await r.json();
        if (d.success) {
            showApp();
            toast('Logged in!', 'success');
        } else if (d.needs_2fa) {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('pin-form').classList.remove('hidden');
            toast('Check your phone for SMS PIN', 'info');
        } else {
            toast(d.detail || d.message || 'Login failed', 'error');
        }
    } catch (e) {
        toast('Login failed: ' + e.message, 'error');
    }
}

async function verifyPin() {
    const pin = document.getElementById('pin').value;
    if (!pin) { toast('Enter PIN', 'error'); return; }
    
    // Show loading spinner
    document.getElementById('verify-btn').disabled = true;
    document.getElementById('login-loading').classList.add('active');
    document.querySelector('#login-loading .loading-text').textContent = 'Verifying PIN...';
    
    try {
        const r = await fetch('/api/verify-pin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({pin: pin, remember_me: window.rememberMe !== false})
        });
        
        // Update loading text
        document.querySelector('#login-loading .loading-text').textContent = 'Connecting to Blink servers...';
        
        const d = await r.json();
        if (d.success) {
            document.querySelector('#login-loading .loading-text').textContent = 'Loading cameras...';
            showApp();
            toast('Verified!', 'success');
        } else {
            toast(d.detail || 'Invalid PIN', 'error');
        }
    } catch (e) {
        toast('Verification failed', 'error');
    } finally {
        document.getElementById('verify-btn').disabled = false;
        document.getElementById('login-loading').classList.remove('active');
    }
}

async function resendPin() {
    toast('Requesting new PIN...', 'info');
    try {
        const r = await fetch('/api/resend-pin', {method: 'POST'});
        const d = await r.json();
        toast(d.message || 'PIN request sent', 'success');
    } catch (e) {
        toast('Failed to resend PIN', 'error');
    }
}

function backToLogin() {
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('pin-form').classList.add('hidden');
    document.getElementById('pin').value = '';
}

async function loginSaved() {
    toast('Loading saved credentials...', 'info');
    
    // Show loading spinner in a cleaner way
    document.getElementById('login-form').classList.add('hidden');
    document.getElementById('pin-form').classList.add('hidden');
    
    // Create a simple loading overlay
    const loginCard = document.querySelector('.login-card');
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'saved-login-loading';
    loadingDiv.innerHTML = '<div class="loading-spinner active" style="position:relative;padding:2rem"><div class="spinner"></div><div class="loading-text">Connecting with saved credentials...</div></div>';
    loginCard.appendChild(loadingDiv);
    
    try {
        const r = await fetch('/api/login/saved', {method: 'POST'});
        const d = await r.json();
        
        // Remove loading
        const loadEl = document.getElementById('saved-login-loading');
        if (loadEl) loadEl.remove();
        
        if (d.success) {
            showApp();
            toast('Logged in!', 'success');
        } else if (d.needs_2fa) {
            document.getElementById('pin-form').classList.remove('hidden');
            toast('2FA required - credentials may have expired', 'info');
        } else {
            document.getElementById('login-form').classList.remove('hidden');
            toast(d.detail || 'No saved credentials', 'error');
        }
    } catch (e) {
        // Remove loading
        const loadEl = document.getElementById('saved-login-loading');
        if (loadEl) loadEl.remove();
        
        document.getElementById('login-form').classList.remove('hidden');
        toast('Failed to load credentials', 'error');
    }
}

async function logout() {
    try { await fetch('/api/logout', {method: 'POST'}); } catch (e) {}
    demoMode = false;
    cameras = [];
    syncModules = [];
    document.getElementById('app-layout').classList.remove('active');
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('demo-banner').classList.add('hidden');
    document.getElementById('login-form').classList.remove('hidden');
    document.getElementById('pin-form').classList.add('hidden');
    document.getElementById('pin').value = '';
    document.getElementById('status-dot').classList.remove('online', 'demo');
    document.getElementById('status-text').textContent = 'Offline';
}

async function doLogout() {
    if (!confirm('Logout? Your saved credentials will be kept for quick re-login.')) return;
    await logout();
    toast('Logged out', 'success');
}

async function forgetCredentials() {
    if (!confirm('Delete saved credentials? You will need to complete 2FA on next login.')) return;
    try {
        const r = await fetch('/api/forget-credentials', {method: 'POST'});
        const d = await r.json();
        if (d.success) {
            toast(d.message || 'Credentials deleted', 'success');
        } else {
            toast(d.detail || 'Failed', 'error');
        }
    } catch (e) {
        toast('Error: ' + e.message, 'error');
    }
}

function enterDemoMode() {
    demoMode = true;
    document.getElementById('demo-banner').classList.remove('hidden');
    document.getElementById('sidebar').classList.add('demo-active');
    document.getElementById('main-content').classList.add('demo-active');
    document.getElementById('status-dot').classList.add('demo');
    document.getElementById('status-text').textContent = 'Demo Mode';
    showApp();
    loadDemoData();
}

function exitDemoMode() {
    demoMode = false;
    document.getElementById('demo-banner').classList.add('hidden');
    document.getElementById('sidebar').classList.remove('demo-active');
    document.getElementById('main-content').classList.remove('demo-active');
    document.getElementById('app-layout').classList.remove('active');
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('status-dot').classList.remove('demo');
}

function showApp() {
    document.getElementById('loading-screen').classList.add('hidden');
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app-layout').classList.add('active');
    if (!demoMode) {
        loadStatus();
        loadCameras();
        loadVideos();
        loadTagsAndGroups();
        loadVideoDayCounts();
        setInterval(() => { if (!demoMode) loadStatus(); }, 30000);
    }
}

function loadDemoData() {
    cameras = [
        {name: 'Front Door', camera_type: 'outdoor', motion_enabled: true, power_display: 'OK', temperature: 65, wifi_strength: 4, thumbnail: true, last_record: '2025-12-09T14:30:00'},
        {name: 'Backyard', camera_type: 'outdoor', motion_enabled: true, power_display: 'Low', temperature: 58, wifi_strength: 2, thumbnail: true, last_record: '2025-12-09T12:15:00'},
        {name: 'Garage', camera_type: 'mini', motion_enabled: false, power_display: 'USB', temperature: 55, wifi_strength: 3, thumbnail: false}
    ];
    syncModules = [{name: 'Home Base', status: 'online', armed: true, cameras_count: 3, cameras: ['Front Door', 'Backyard', 'Garage']}];
    videos = [
        {id: '1', camera_name: 'Front Door', created_at: '2025-12-09T14:30:00', duration: 15, starred: false, file_size: 2500000},
        {id: '2', camera_name: 'Backyard', created_at: '2025-12-09T12:15:00', duration: 22, starred: true, file_size: 3200000}
    ];
    tags = [{id: 1, name: 'Motion', color: '#10b981', video_count: 5}];
    groups = [{id: 1, name: 'Outdoor', color: '#3b82f6', cameras: ['Front Door', 'Backyard']}];
    
    document.getElementById('stat-cameras').textContent = cameras.length;
    document.getElementById('stat-videos').textContent = '127';
    document.getElementById('stat-storage').textContent = '2.4 GB';
    document.getElementById('stat-today').textContent = '12';
    document.getElementById('stat-disk').textContent = '450 GB';
    document.getElementById('stat-disk-pct').textContent = '45% used';
    document.getElementById('stat-cloud').textContent = '‚úì';
    document.getElementById('stat-cloud-sub').textContent = 'All synced';
    document.getElementById('status-dot').classList.add('online');
    document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
    
    // Populate demo dashboard with compact health grid
    let healthHtml = '<div class="health-grid">';
    healthHtml += '<div class="health-dot good" title="Front Door">FD</div>';
    healthHtml += '<div class="health-dot warn" title="Backyard - Low Battery">BY</div>';
    healthHtml += '<div class="health-dot good" title="Garage">GA</div>';
    healthHtml += '</div>';
    healthHtml += '<div style="display:flex;gap:1rem;font-size:0.7rem;color:var(--text-muted);margin-bottom:0.75rem"><span>üü¢ Healthy: 2</span><span>üü° Low Battery: 1</span></div>';
    healthHtml += '<div class="alert-item alert-warning"><span class="alert-icon">üîã</span><div class="alert-text">Low battery: Backyard</div></div>';
    document.getElementById('dash-camera-health').innerHTML = healthHtml;
    
    document.getElementById('dash-active-cameras').innerHTML = 
        '<div class="bar-row"><div class="bar-label">Front Door</div><div class="bar-track"><div class="bar-fill" style="width:100%;background:#3b82f6"></div></div><div class="bar-count">45</div></div>' +
        '<div class="bar-row"><div class="bar-label">Backyard</div><div class="bar-track"><div class="bar-fill" style="width:66%;background:#8b5cf6"></div></div><div class="bar-count">30</div></div>' +
        '<div class="bar-row"><div class="bar-label">Garage</div><div class="bar-track"><div class="bar-fill" style="width:33%;background:#10b981"></div></div><div class="bar-count">15</div></div>';
    document.getElementById('dash-schedule').innerHTML = 
        '<div class="alert-item alert-success"><span class="alert-icon">‚úÖ</span><div><div class="alert-text">Scheduled downloads enabled</div><div class="alert-sub">Every day at 03:00 ‚Ä¢ 7 days back</div></div></div>' +
        '<div class="alert-item alert-success"><span class="alert-icon">üîÑ</span><div><div class="alert-text">Continuous sync active</div><div class="alert-sub">Checking every 5 minutes</div></div></div>';
    document.getElementById('dash-recent').innerHTML = videos.map(v => 
        '<div class="alert-item alert-info"><span class="alert-icon">üé¨</span><div><div class="alert-text">' + v.camera_name + '</div><div class="alert-sub">' + formatDateTime(v.created_at) + '</div></div></div>'
    ).join('');
    
    renderSyncModules();
    renderCameras();
    renderVideos();
    populateFilters();
    renderTags();
    renderGroups();
}

// === Data Loading ===
async function loadStatus() {
    try {
        const r = await fetch('/api/status');
        const d = await r.json();
        
        document.getElementById('stat-videos').textContent = d.stats?.total_videos || 0;
        document.getElementById('stat-storage').textContent = formatBytes(d.stats?.total_bytes || 0);
        document.getElementById('stat-today').textContent = d.stats?.today_count || 0;
        document.getElementById('stat-disk').textContent = d.disk?.free_formatted || '--';
        document.getElementById('stat-disk-pct').textContent = (d.disk?.percent_used || 0) + '% used';
        document.getElementById('storage-path').textContent = d.settings?.download_dir || '--';
        
        if (d.settings?.continuous_sync_enabled) {
            document.getElementById('toggle-sync').classList.add('active');
        }
        document.getElementById('sync-interval').value = d.settings?.sync_interval_minutes || 5;
        
        document.getElementById('status-dot').classList.add('online');
        document.getElementById('status-text').textContent = 'Online';
        document.getElementById('sidebar-version').textContent = 'v' + (d.version || '?');
        document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
    } catch (e) {
        document.getElementById('status-dot').classList.remove('online');
        document.getElementById('status-text').textContent = 'Offline';
    }
}

async function updateDashboardInsights() {
    // Camera Health - redesigned for usability
    const healthEl = document.getElementById('dash-camera-health');
    if (healthEl) {
        const offline = cameras.filter(c => c.online_status === 'offline');
        const lowBattery = cameras.filter(c => c.power_display && (c.power_display.toLowerCase().includes('low') || c.power_display.toLowerCase().includes('critical')));
        const weakSignal = cameras.filter(c => c.wifi_strength !== null && c.wifi_strength !== undefined && c.wifi_strength <= 1 && c.online_status !== 'offline');
        const motionDisabled = cameras.filter(c => c.motion_enabled === false && c.online_status !== 'offline');
        const highTemp = cameras.filter(c => c.temperature && c.temperature > 100);
        const lowTemp = cameras.filter(c => c.temperature && c.temperature < 32);
        const healthy = cameras.filter(c => {
            const isOffline = c.online_status === 'offline';
            const isLowBat = c.power_display && c.power_display.toLowerCase().includes('low');
            const isWeakSig = c.wifi_strength !== null && c.wifi_strength !== undefined && c.wifi_strength <= 1;
            return !isOffline && !isLowBat && !isWeakSig;
        });
        
        let healthHtml = '';
        
        if (cameras.length > 0) {
            // Clickable summary cards that expand to show lists
            healthHtml += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:0.5rem;margin-bottom:0.75rem">';
            
            // Healthy
            healthHtml += '<div class="health-stat-card" onclick="toggleHealthList(\'healthy\')" style="background:var(--bg-primary);padding:0.75rem;border-radius:var(--radius-sm);cursor:pointer;text-align:center;border:2px solid transparent;transition:border-color 0.2s">' +
                '<div style="font-size:1.5rem;font-weight:700;color:var(--success)">' + healthy.length + '</div>' +
                '<div style="font-size:0.7rem;color:var(--text-muted)">‚úÖ Healthy</div></div>';
            
            // Offline (most critical)
            healthHtml += '<div class="health-stat-card" onclick="toggleHealthList(\'offline\')" style="background:var(--bg-primary);padding:0.75rem;border-radius:var(--radius-sm);cursor:pointer;text-align:center;border:2px solid ' + (offline.length ? 'var(--danger)' : 'transparent') + '">' +
                '<div style="font-size:1.5rem;font-weight:700;color:' + (offline.length ? 'var(--danger)' : 'var(--text-muted)') + '">' + offline.length + '</div>' +
                '<div style="font-size:0.7rem;color:var(--text-muted)">‚ö´ Offline</div></div>';
            
            // Low Battery
            healthHtml += '<div class="health-stat-card" onclick="toggleHealthList(\'lowbattery\')" style="background:var(--bg-primary);padding:0.75rem;border-radius:var(--radius-sm);cursor:pointer;text-align:center;border:2px solid ' + (lowBattery.length ? 'var(--warning)' : 'transparent') + '">' +
                '<div style="font-size:1.5rem;font-weight:700;color:' + (lowBattery.length ? 'var(--warning)' : 'var(--text-muted)') + '">' + lowBattery.length + '</div>' +
                '<div style="font-size:0.7rem;color:var(--text-muted)">üîã Low Battery</div></div>';
            
            // Weak Signal
            healthHtml += '<div class="health-stat-card" onclick="toggleHealthList(\'weaksignal\')" style="background:var(--bg-primary);padding:0.75rem;border-radius:var(--radius-sm);cursor:pointer;text-align:center;border:2px solid ' + (weakSignal.length ? 'var(--danger)' : 'transparent') + '">' +
                '<div style="font-size:1.5rem;font-weight:700;color:' + (weakSignal.length ? 'var(--danger)' : 'var(--text-muted)') + '">' + weakSignal.length + '</div>' +
                '<div style="font-size:0.7rem;color:var(--text-muted)">üì∂ Weak Signal</div></div>';
            
            // Motion Off
            healthHtml += '<div class="health-stat-card" onclick="toggleHealthList(\'motionoff\')" style="background:var(--bg-primary);padding:0.75rem;border-radius:var(--radius-sm);cursor:pointer;text-align:center;border:2px solid transparent">' +
                '<div style="font-size:1.5rem;font-weight:700;color:var(--text-muted)">' + motionDisabled.length + '</div>' +
                '<div style="font-size:0.7rem;color:var(--text-muted)">üîï Motion Off</div></div>';
            
            healthHtml += '</div>';
            
            // Hidden lists that appear when clicked
            healthHtml += '<div id="health-list-healthy" class="health-list" style="display:none;background:var(--bg-primary);padding:0.75rem;border-radius:var(--radius-sm);margin-bottom:0.5rem">' +
                '<div style="font-size:0.7rem;color:var(--success);font-weight:600;margin-bottom:0.5rem">‚úÖ Healthy Cameras (' + healthy.length + ')</div>' +
                '<div style="display:flex;flex-wrap:wrap;gap:0.25rem">' + healthy.map(c => 
                    '<span class="badge badge-success" style="cursor:pointer;font-size:0.7rem" onclick="openCameraModal(\'' + c.name + '\')">' + c.name + '</span>'
                ).join('') + '</div></div>';
            
            healthHtml += '<div id="health-list-offline" class="health-list" style="display:none;background:var(--bg-primary);padding:0.75rem;border-radius:var(--radius-sm);margin-bottom:0.5rem">' +
                '<div style="font-size:0.7rem;color:var(--danger);font-weight:600;margin-bottom:0.5rem">‚ö´ Offline Cameras (' + offline.length + ')</div>' +
                '<div style="font-size:0.65rem;color:var(--text-muted);margin-bottom:0.5rem">Battery-powered cameras may need new batteries</div>' +
                '<div style="display:flex;flex-wrap:wrap;gap:0.25rem">' + offline.map(c => {
                    let lastSeen = '';
                    if (c.thumbnail_age_hours !== null && c.thumbnail_age_hours !== undefined) {
                        const h = c.thumbnail_age_hours;
                        if (h < 24) lastSeen = ' (' + Math.round(h) + 'h ago)';
                        else lastSeen = ' (' + Math.round(h/24) + 'd ago)';
                    }
                    return '<span class="badge" style="cursor:pointer;font-size:0.7rem;background:rgba(239,68,68,0.2);color:var(--danger)" onclick="openCameraModal(\'' + c.name + '\')">' + c.name + lastSeen + '</span>';
                }).join('') + (offline.length === 0 ? '<span style="color:var(--text-muted);font-size:0.75rem">None</span>' : '') + '</div></div>';
            
            healthHtml += '<div id="health-list-lowbattery" class="health-list" style="display:none;background:var(--bg-primary);padding:0.75rem;border-radius:var(--radius-sm);margin-bottom:0.5rem">' +
                '<div style="font-size:0.7rem;color:var(--warning);font-weight:600;margin-bottom:0.5rem">üîã Low Battery (' + lowBattery.length + ')</div>' +
                '<div style="display:flex;flex-wrap:wrap;gap:0.25rem">' + lowBattery.map(c => 
                    '<span class="badge badge-warning" style="cursor:pointer;font-size:0.7rem" onclick="openCameraModal(\'' + c.name + '\')">' + c.name + '</span>'
                ).join('') + (lowBattery.length === 0 ? '<span style="color:var(--text-muted);font-size:0.75rem">None</span>' : '') + '</div></div>';
            
            healthHtml += '<div id="health-list-weaksignal" class="health-list" style="display:none;background:var(--bg-primary);padding:0.75rem;border-radius:var(--radius-sm);margin-bottom:0.5rem">' +
                '<div style="font-size:0.7rem;color:var(--danger);font-weight:600;margin-bottom:0.5rem">üì∂ Weak Signal (' + weakSignal.length + ')</div>' +
                '<div style="display:flex;flex-wrap:wrap;gap:0.25rem">' + weakSignal.map(c => 
                    '<span class="badge badge-warning" style="cursor:pointer;font-size:0.7rem;background:rgba(239,68,68,0.2);color:var(--danger)" onclick="openCameraModal(\'' + c.name + '\')">' + c.name + '</span>'
                ).join('') + (weakSignal.length === 0 ? '<span style="color:var(--text-muted);font-size:0.75rem">None</span>' : '') + '</div></div>';
            
            healthHtml += '<div id="health-list-motionoff" class="health-list" style="display:none;background:var(--bg-primary);padding:0.75rem;border-radius:var(--radius-sm);margin-bottom:0.5rem">' +
                '<div style="font-size:0.7rem;color:var(--text-muted);font-weight:600;margin-bottom:0.5rem">üîï Motion Disabled (' + motionDisabled.length + ')</div>' +
                '<div style="display:flex;flex-wrap:wrap;gap:0.25rem">' + motionDisabled.map(c => 
                    '<span class="badge badge-secondary" style="cursor:pointer;font-size:0.7rem" onclick="openCameraModal(\'' + c.name + '\')">' + c.name + '</span>'
                ).join('') + (motionDisabled.length === 0 ? '<span style="color:var(--text-muted);font-size:0.75rem">None</span>' : '') + '</div></div>';
        }
        
        // Temperature alerts
        if (highTemp.length > 0) {
            healthHtml += '<div class="alert-item alert-warning"><span class="alert-icon">üå°Ô∏è</span><div class="alert-text">High temp: ' + highTemp.map(c => '<span style="cursor:pointer;text-decoration:underline" onclick="openCameraModal(\'' + c.name + '\')">' + c.name + ' (' + c.temperature + '¬∞F)</span>').join(', ') + '</div></div>';
        }
        if (lowTemp.length > 0) {
            healthHtml += '<div class="alert-item alert-info"><span class="alert-icon">‚ùÑÔ∏è</span><div class="alert-text">Cold temp: ' + lowTemp.map(c => '<span style="cursor:pointer;text-decoration:underline" onclick="openCameraModal(\'' + c.name + '\')">' + c.name + ' (' + c.temperature + '¬∞F)</span>').join(', ') + '</div></div>';
        }
        
        if (cameras.length === 0) {
            healthHtml = '<p style="color:var(--text-muted);font-size:0.85rem">No cameras loaded</p>';
        }
        
        healthEl.innerHTML = healthHtml || '<p style="color:var(--text-muted);font-size:0.85rem">No cameras found</p>';
    }
    
    // Load active cameras chart with current day selection
    updateActiveChart();
    
    // Schedule Status
    const schedEl = document.getElementById('dash-schedule');
    if (schedEl) {
        try {
            const r = await fetch('/api/status');
            const d = await r.json();
            const settings = d.settings || {};
            
            let schedHtml = '';
            if (settings.schedule_enabled) {
                schedHtml = '<div class="alert-item alert-success"><span class="alert-icon">‚úÖ</span><div><div class="alert-text">Scheduled downloads enabled</div>' +
                    '<div class="alert-sub">Every day at ' + (settings.schedule_time || '03:00') + ' ‚Ä¢ ' + (settings.schedule_days || 7) + ' days back</div></div></div>';
            } else {
                schedHtml = '<div class="alert-item alert-info"><span class="alert-icon">‚è∏Ô∏è</span><div class="alert-text">Scheduled downloads disabled</div></div>';
            }
            
            if (settings.continuous_sync_enabled) {
                schedHtml += '<div class="alert-item alert-success"><span class="alert-icon">üîÑ</span><div><div class="alert-text">Continuous sync active</div>' +
                    '<div class="alert-sub">Checking every ' + (settings.sync_interval_minutes || 5) + ' minutes</div></div></div>';
            }
            
            schedEl.innerHTML = schedHtml || '<div class="alert-item alert-info"><span class="alert-icon">‚è∏Ô∏è</span><div class="alert-text">No automation configured</div></div>';
        } catch (e) {
            schedEl.innerHTML = '<p style="color:var(--text-muted);font-size:0.85rem">Failed to load</p>';
        }
    }
    
    // Recent Downloads
    const recentEl = document.getElementById('dash-recent');
    if (recentEl) {
        try {
            const r = await fetch('/api/local-videos?per_page=8');
            const d = await r.json();
            const recent = d.videos || [];
            
            if (recent.length === 0) {
                recentEl.innerHTML = '<p style="color:var(--text-muted);font-size:0.85rem">No recent downloads</p>';
            } else {
                recentEl.innerHTML = recent.slice(0, 8).map(v => 
                    '<div class="alert-item alert-info" style="cursor:pointer" onclick="switchTab(\'videos\')">' +
                    '<span class="alert-icon">üé¨</span>' +
                    '<div><div class="alert-text">' + v.camera_name + '</div>' +
                    '<div class="alert-sub">' + formatDateTime(v.created_at) + '</div></div></div>'
                ).join('');
            }
        } catch (e) {
            recentEl.innerHTML = '<p style="color:var(--text-muted);font-size:0.85rem">Failed to load</p>';
        }
    }
}

async function updateActiveChart() {
    const activeEl = document.getElementById('dash-active-cameras');
    const daysEl = document.getElementById('dash-active-days');
    if (!activeEl) return;
    
    const days = daysEl ? parseInt(daysEl.value) : 7;
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - days);
    
    try {
        const params = new URLSearchParams({per_page: '1000', start_date: startDate.toISOString().split('T')[0]});
        const r = await fetch('/api/local-videos?' + params);
        const d = await r.json();
        const vids = d.videos || [];
        
        // Count videos per camera
        const counts = {};
        vids.forEach(v => {
            counts[v.camera_name] = (counts[v.camera_name] || 0) + 1;
        });
        
        // Sort and take top 5
        const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5);
        const maxCount = sorted.length > 0 ? sorted[0][1] : 1;
        
        // Color palette for bars
        const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];
        
        if (sorted.length === 0) {
            activeEl.innerHTML = '<p style="color:var(--text-muted);font-size:0.85rem">No videos in this period</p>';
        } else {
            activeEl.innerHTML = sorted.map(([cam, count], i) => 
                '<div class="bar-row">' +
                '<div class="bar-label" title="' + cam + '">' + cam + '</div>' +
                '<div class="bar-track"><div class="bar-fill" style="width:' + (count/maxCount*100) + '%;background:' + colors[i % colors.length] + '"></div></div>' +
                '<div class="bar-count">' + count + '</div></div>'
            ).join('');
        }
    } catch (e) {
        activeEl.innerHTML = '<p style="color:var(--text-muted);font-size:0.85rem">Failed to load</p>';
    }
}

async function loadCameras() {
    if (demoMode) return;
    try {
        const r = await fetch('/api/cameras');
        const d = await r.json();
        cameras = d.cameras || [];
        syncModules = d.sync_modules || [];
        document.getElementById('stat-cameras').textContent = cameras.length;
        renderCameras();
        renderSyncModules();
        populateFilters();
        updateDashboardInsights();
    } catch (e) {
        console.error('Failed to load cameras', e);
    }
}

async function loadVideos() {
    if (demoMode) { renderVideos(); return; }
    
    const params = new URLSearchParams();
    const camEl = document.getElementById('vid-camera');
    const grpEl = document.getElementById('vid-group');
    const dfEl = document.getElementById('vid-date-from');
    const dtEl = document.getElementById('vid-date-to');
    const tagEl = document.getElementById('vid-tag');
    
    const cam = camEl ? camEl.value : '';
    const grp = grpEl ? grpEl.value : '';
    const df = dfEl ? dfEl.value : '';
    const dt = dtEl ? dtEl.value : '';
    const tag = tagEl ? tagEl.value : '';
    
    if (cam) params.set('cameras', cam);
    if (grp) params.set('camera_groups', grp);
    if (df) params.set('start_date', df);
    if (dt) params.set('end_date', dt);
    if (tag) params.set('tags', tag);
    if (window.starredFilter) params.set('starred', 'true');
    params.set('page', videoPage);
    params.set('per_page', 50);
    
    try {
        const r = await fetch('/api/local-videos?' + params);
        if (!r.ok) {
            throw new Error('HTTP ' + r.status);
        }
        const d = await r.json();
        videos = d.videos || [];
        renderVideos();
        renderPagination(d.page || 1, d.total_pages || 1);
        
        // Show count in filter area
        const countEl = document.getElementById('video-count');
        if (countEl) countEl.textContent = d.total || videos.length;
    } catch (e) {
        console.error('Failed to load videos', e);
        const el = document.getElementById('video-grid');
        if (el) el.innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Failed to load videos: ' + e.message + '</p></div>';
    }
}

let downloadStatusInterval = null;

async function checkDownloadStatus() {
    if (demoMode) return;
    try {
        const r = await fetch('/api/download/status');
        const d = await r.json();
        const banner = document.getElementById('download-status-banner');
        
        if (d.running) {
            banner.classList.remove('hidden');
            const total = d.total || 0;
            const done = (d.downloaded || 0) + (d.skipped || 0);
            const percent = total > 0 ? Math.round((done / total) * 100) : 0;
            
            document.getElementById('download-status-text').textContent = 
                done + ' of ' + total + ' ‚Ä¢ ' + (d.current_camera || 'Scanning...');
            document.getElementById('download-status-percent').textContent = percent + '%';
            
            // Start polling if not already
            if (!downloadStatusInterval) {
                downloadStatusInterval = setInterval(checkDownloadStatus, 2000);
            }
        } else {
            banner.classList.add('hidden');
            // Stop polling and refresh videos if we were downloading
            if (downloadStatusInterval) {
                clearInterval(downloadStatusInterval);
                downloadStatusInterval = null;
                loadVideos(); // Refresh video list
            }
        }
    } catch (e) {
        console.error('Failed to check download status', e);
    }
}

// Check download status on page load and periodically
setInterval(checkDownloadStatus, 10000); // Check every 10 seconds even when not downloading

async function loadTagsAndGroups() {
    if (demoMode) return;
    try {
        let r = await fetch('/api/tags');
        let d = await r.json();
        tags = d.tags || [];
        
        r = await fetch('/api/camera-groups');
        d = await r.json();
        groups = d.groups || [];
        
        populateFilters();
        populateCameraGroupFilter();
        renderTags();
        renderGroups();
    } catch (e) {
        console.error('Failed to load tags/groups', e);
    }
}

function populateFilters() {
    // Camera filter
    const camSel = document.getElementById('vid-camera');
    const camVal = camSel.value;
    camSel.innerHTML = '<option value="">All Cameras</option>' + 
        cameras.map(c => '<option value="' + c.name + '">' + c.name + '</option>').join('');
    camSel.value = camVal;
    
    // Group filter
    const grpSel = document.getElementById('vid-group');
    const grpVal = grpSel.value;
    grpSel.innerHTML = '<option value="">All Groups</option>' + 
        groups.map(g => '<option value="' + g.name + '">' + g.name + '</option>').join('');
    grpSel.value = grpVal;
    
    // Tag filter
    const tagSel = document.getElementById('vid-tag');
    const tagVal = tagSel.value;
    tagSel.innerHTML = '<option value="">All Tags</option>' + 
        tags.map(t => '<option value="' + t.name + '">' + t.name + ' (' + (t.video_count || 0) + ')</option>').join('');
    tagSel.value = tagVal;
}

// === Rendering ===
function renderSyncModules() {
    // Render on dedicated Sync tab (full view with controls)
    const syncEl = document.getElementById('sync-grid');
    if (!syncEl) return;
    
    // Apply grid sizing
    syncEl.style.gridTemplateColumns = 'repeat(' + syncGridSize + ', 1fr)';
    
    if (!syncModules.length) {
        syncEl.innerHTML = '<div class="empty-state"><div class="icon">üì°</div><p>No sync modules found</p></div>';
        return;
    }
    
    syncEl.innerHTML = syncModules.map(s => {
        const statusText = s.status === 'online' ? 'Online' : (s.status === 'offline' ? 'Offline' : (s.status || 'Unknown'));
        const statusClass = s.status === 'online' ? 'success' : (s.status === 'offline' ? 'warning' : 'warning');
        
        // Separate Mini cameras from sync module cameras
        const syncCams = s.sync_cameras || (s.cameras || []).filter(c => {
            const cam = cameras.find(cam => cam.name === c);
            return !cam || !cam.camera_type || !cam.camera_type.toLowerCase().includes('mini');
        });
        const miniCams = s.mini_cameras || (s.cameras || []).filter(c => {
            const cam = cameras.find(cam => cam.name === c);
            return cam && cam.camera_type && cam.camera_type.toLowerCase().includes('mini');
        });
        
        // Build clickable camera list for sync module cameras
        let syncCameraLinks = '';
        if (syncCams.length) {
            syncCameraLinks = '<div style="margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border)">' +
                '<div style="font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:0.5rem">üì° Sync Module Cameras</div>' +
                '<div style="display:flex;flex-wrap:wrap;gap:0.25rem">' +
                syncCams.map(camName => 
                    '<span class="badge badge-secondary" style="cursor:pointer;font-size:0.7rem" onclick="event.stopPropagation();openCameraModal(\'' + camName + '\')">' + camName + '</span>'
                ).join('') +
                '</div></div>';
        }
        
        // Build clickable camera list for Mini cameras
        let miniCameraLinks = '';
        if (miniCams.length) {
            miniCameraLinks = '<div style="margin-top:0.5rem">' +
                '<div style="font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:0.5rem">üîå Mini Cameras (WiFi only)</div>' +
                '<div style="display:flex;flex-wrap:wrap;gap:0.25rem">' +
                miniCams.map(camName => 
                    '<span class="badge" style="cursor:pointer;font-size:0.7rem;background:var(--bg-primary);border:1px solid var(--border)" onclick="event.stopPropagation();openCameraModal(\'' + camName + '\')">' + camName + '</span>'
                ).join('') +
                '</div></div>';
        }
        
        // Armed state styling - green when armed, red when disarmed
        const armColor = s.armed ? 'var(--success)' : 'var(--danger)';
        const armText = s.armed ? 'Armed' : 'Disarmed';
        
        // WiFi signal bars
        const wifiStrength = s.wifi_strength || 0;
        const wifiHtml = wifiStrength ? 
            '<div class="signal-bars" style="margin-left:0.25rem">' +
            '<div class="bar' + (wifiStrength >= 1 ? ' active' : '') + '"></div>' +
            '<div class="bar' + (wifiStrength >= 2 ? ' active' : '') + '"></div>' +
            '<div class="bar' + (wifiStrength >= 3 ? ' active' : '') + '"></div>' +
            '<div class="bar' + (wifiStrength >= 4 ? ' active' : '') + '"></div>' +
            '</div>' : '<span style="color:var(--text-muted)">--</span>';
        
        return '<div class="sync-card">' +
            '<div class="header"><span class="icon" style="font-size:2rem">üì°</span><div style="flex:1">' +
            '<div class="name" style="font-size:1.1rem">' + s.name + '</div>' +
            '<div class="status" style="display:flex;gap:0.5rem;align-items:center;margin-top:0.25rem">' +
            '<span class="badge badge-' + statusClass + '">' + statusText + '</span>' +
            '<span style="font-size:0.8rem;color:var(--text-muted)">' + syncCams.length + ' cameras' + (miniCams.length ? ' + ' + miniCams.length + ' minis' : '') + '</span>' +
            '</div></div></div>' +
            '<div class="stats" style="margin:1rem 0">' +
            '<div class="stat"><div class="stat-label">WiFi Signal</div><div style="display:flex;align-items:center">' + wifiHtml + '</div></div>' +
            '<div class="stat"><div class="stat-label">Network</div><div style="font-size:0.75rem">' + (s.wifi_ssid || '--') + '</div></div>' +
            '</div>' +
            '<div style="display:flex;gap:0.5rem;align-items:center">' +
            '<div class="toggle-switch" style="display:flex;align-items:center;gap:0.5rem">' +
            '<span style="font-size:0.75rem;color:' + armColor + ';font-weight:600">' + armText + '</span>' +
            '<label class="switch" style="position:relative;display:inline-block;width:44px;height:24px">' +
            '<input type="checkbox" ' + (s.armed ? 'checked' : '') + ' onchange="toggleArmSync(\'' + s.name + '\', this.checked)" style="opacity:0;width:0;height:0">' +
            '<span class="slider" style="position:absolute;cursor:pointer;inset:0;background:' + armColor + ';border-radius:24px;transition:.3s;border:1px solid var(--border)"></span>' +
            '</label>' +
            '</div>' +
            '<button class="btn btn-sm btn-ghost" onclick="openSyncModal(\'' + s.name + '\')">üìã Details</button>' +
            '</div>' +
            syncCameraLinks + miniCameraLinks +
            '</div>';
    }).join('');
}

function renderCameras() {
    const el = document.getElementById('camera-grid');
    
    // Apply exact grid column count
    el.style.gridTemplateColumns = 'repeat(' + cameraGridSize + ', 1fr)';
    
    // Filter cameras by group
    let filteredCameras = cameras;
    if (cameraGroupFilter) {
        filteredCameras = cameras.filter(c => {
            if (!c.groups || !c.groups.length) return false;
            return c.groups.some(g => g.name === cameraGroupFilter);
        });
    }
    
    if (!filteredCameras.length) {
        el.innerHTML = '<div class="empty-state"><div class="icon">üì∑</div><p>' + 
            (cameraGroupFilter ? 'No cameras in this group' : 'No cameras found') + '</p></div>';
        return;
    }
    
    el.innerHTML = filteredCameras.map(c => {
        // Format last activity time - show actual date/time
        let lastActivity = '';
        if (c.last_record) {
            const d = new Date(c.last_record);
            // Format as "Dec 12, 5:30 PM"
            lastActivity = d.toLocaleDateString('en-US', {month:'short', day:'numeric'}) + ', ' + 
                          d.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'});
        }
        
        // Power display - uppercase
        const powerText = (c.power_display || '--').toUpperCase();
        
        // Check if camera is offline
        const isOffline = c.online_status === 'offline';
        
        // Color logic: red for bad states, green for good/USB
        const powerLower = (c.power_display || '').toLowerCase();
        const isBadBattery = powerLower.includes('low') || powerLower.includes('dead') || powerLower.includes('critical') || powerLower.includes('offline');
        const isGoodPower = c.power_source === 'usb' || powerLower.includes('ok') || powerLower.includes('good');
        const batteryColor = isOffline ? 'var(--danger)' : (isBadBattery ? 'var(--danger)' : (isGoodPower ? 'var(--success)' : 'inherit'));
        
        // Offline indicator for card
        const offlineClass = isOffline ? ' camera-offline' : '';
        const offlineBadge = isOffline ? '<span class="badge" style="font-size:0.6rem;background:rgba(239,68,68,0.2);color:var(--danger)">‚ö´ Offline</span>' : '';
        
        // Signal bars - convert dBm to bars (wifi_strength is typically -30 to -90 dBm)
        // -30 to -50 = excellent (4 bars), -50 to -60 = good (3 bars), -60 to -70 = fair (2 bars), -70+ = poor (1 bar)
        let signalBars = 0;
        let hasSignal = false;
        if (!isOffline && c.wifi_strength !== null && c.wifi_strength !== undefined && c.wifi_strength !== '--') {
            hasSignal = true;
            const sig = parseInt(c.wifi_strength);
            if (!isNaN(sig)) {
                if (sig >= -50 || sig >= 4) signalBars = 4;
                else if (sig >= -60 || sig >= 3) signalBars = 3;
                else if (sig >= -70 || sig >= 2) signalBars = 2;
                else signalBars = 1;
            }
        }
        const signalHtml = hasSignal ? '<div class="signal-bars" style="margin-left:auto" title="' + c.wifi_strength + ' dBm">' +
            '<div class="bar ' + (signalBars >= 1 ? 'active' : '') + '"></div>' +
            '<div class="bar ' + (signalBars >= 2 ? 'active' : '') + '"></div>' +
            '<div class="bar ' + (signalBars >= 3 ? 'active' : '') + '"></div>' +
            '<div class="bar ' + (signalBars >= 4 ? 'active' : '') + '"></div></div>' : (isOffline ? '<span style="margin-left:auto;color:var(--danger);font-size:0.75rem">üì∂ --</span>' : '');
        
        return '<div class="camera-card' + offlineClass + '">' +
            '<div class="thumb" onclick="openCameraModal(\'' + c.name + '\')">' + 
            (c.thumbnail ? '<img src="/api/camera/' + encodeURIComponent(c.name) + '/thumbnail" onerror="this.style.display=\'none\'"' + (isOffline ? ' style="opacity:0.5"' : '') + '>' : '') +
            '<span class="placeholder" style="' + (c.thumbnail ? 'display:none' : '') + '">üì∑</span>' +
            (lastActivity ? '<span class="thumb-time">üìπ ' + lastActivity + '</span>' : '') +
            '<div class="thumb-actions">' +
            '<button class="thumb-btn" onclick="event.stopPropagation();snapPicture(\'' + c.name + '\')" title="Snap Picture"' + (isOffline ? ' disabled style="opacity:0.5"' : '') + '>üì∏</button>' +
            '<button class="thumb-btn" onclick="event.stopPropagation();toggleMotion(\'' + c.name + '\',' + !c.motion_enabled + ')" title="' + (c.motion_enabled ? 'Disable' : 'Enable') + ' Motion"' + (isOffline ? ' disabled style="opacity:0.5"' : '') + '>' + (c.motion_enabled ? 'üîï' : 'üîî') + '</button>' +
            '</div>' +
            '</div><div class="info" onclick="openCameraModal(\'' + c.name + '\')">' +
            '<div class="name">' + c.name + ' ' + offlineBadge +
            (isOffline ? '' : ' <span class="badge badge-' + (c.motion_enabled ? 'success' : 'warning') + '" style="font-size:0.6rem">' + (c.motion_enabled ? 'Motion On' : 'Motion Off') + '</span>') + '</div>' +
            '<div class="meta"><span style="color:' + batteryColor + '">' + (isOffline ? '‚ùå' : (c.power_source === 'usb' ? 'üîå' : 'üîã')) + powerText + '</span><span>üå°' + (c.temperature || '--') + '¬∞</span>' +
            signalHtml + '</div></div></div>';
    }).join('');
}

function filterCameras() {
    cameraGroupFilter = document.getElementById('cam-group-filter').value;
    renderCameras();
}

function updateGridSize() {
    cameraGridSize = parseInt(document.getElementById('cam-grid-size').value);
    localStorage.setItem('cameraGridSize', cameraGridSize);
    renderCameras();
}

function updateSyncGridSize() {
    syncGridSize = parseInt(document.getElementById('sync-grid-size').value);
    localStorage.setItem('syncGridSize', syncGridSize);
    renderSyncModules();
}

function updateVideoGridSize() {
    videoGridSize = parseInt(document.getElementById('vid-grid-size').value);
    localStorage.setItem('videoGridSize', videoGridSize);
    renderVideos();
}

function populateCameraGroupFilter() {
    const select = document.getElementById('cam-group-filter');
    if (!select) return;
    select.innerHTML = '<option value="">All Groups</option>' + 
        groups.map(g => '<option value="' + g.name + '">' + g.name + ' (' + (g.cameras ? g.cameras.length : 0) + ')</option>').join('');
}

function renderVideos() {
    const el = document.getElementById('video-grid');
    
    // Apply grid sizing
    el.style.gridTemplateColumns = 'repeat(' + videoGridSize + ', 1fr)';
    
    if (!videos.length) {
        el.innerHTML = '<div class="empty-state"><div class="icon">üé¨</div><p>No videos found. Try different filters or download some videos first.</p></div>';
        return;
    }
    el.innerHTML = videos.map((v, i) => {
        // Get short date for display
        const dateStr = v.created_at ? new Date(v.created_at).toLocaleDateString('en-US', {month:'short', day:'numeric'}) : '';
        const timeStr = v.created_at ? new Date(v.created_at).toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'}) : '';
        
        return '<div class="video-card ' + (selectedVideos.has(v.id) ? 'selected' : '') + '" onclick="handleVideoClick(event, ' + i + ')">' +
        '<div class="select-check" onclick="event.stopPropagation();toggleSelect(\'' + v.id + '\')">' + (selectedVideos.has(v.id) ? '‚úì' : '') + '</div>' +
        '<span class="star ' + (v.starred ? 'active' : '') + '" onclick="event.stopPropagation();quickStar(\'' + v.id + '\',' + i + ')">‚≠ê</span>' +
        '<div class="thumb">' +
        '<img src="/api/local-videos/' + encodeURIComponent(v.id) + '/thumbnail" onerror="this.parentNode.classList.add(\'no-thumb\')">' +
        '<div class="thumb-placeholder" style="display:none;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-muted)">' +
        '<div style="font-size:1.5rem">üìπ</div>' +
        '<div style="font-size:0.65rem;margin-top:0.25rem">' + dateStr + '</div>' +
        '<div style="font-size:0.6rem">' + timeStr + '</div>' +
        '</div>' +
        '<span class="play-icon">‚ñ∂</span>' +
        (v.duration ? '<span class="duration">' + formatDuration(v.duration) + '</span>' : '') +
        '</div><div class="info"><div class="camera">' + v.camera_name + '</div>' +
        '<div class="time">' + formatDateTime(v.created_at) + '</div></div></div>';
    }).join('');
}

function renderPagination(page, total) {
    const el = document.getElementById('video-pagination');
    if (total <= 1) { el.innerHTML = ''; return; }
    el.innerHTML = '<button ' + (page <= 1 ? 'disabled' : '') + ' onclick="goPage(' + (page - 1) + ')">‚Üê Prev</button>' +
        '<span class="page-info">Page ' + page + ' of ' + total + '</span>' +
        '<button ' + (page >= total ? 'disabled' : '') + ' onclick="goPage(' + (page + 1) + ')">Next ‚Üí</button>';
}

function goPage(p) { videoPage = p; loadVideos(); }

// === Video Actions ===
function handleVideoClick(e, idx) {
    if (e.ctrlKey || e.metaKey) {
        toggleSelect(videos[idx].id);
    } else {
        openVideoModal(idx);
    }
}

function toggleSelect(id) {
    if (selectedVideos.has(id)) selectedVideos.delete(id);
    else selectedVideos.add(id);
    updateBulkActions();
    renderVideos();
}

function clearSelection() {
    selectedVideos.clear();
    updateBulkActions();
    renderVideos();
}

function updateBulkActions() {
    const el = document.getElementById('bulk-actions');
    if (selectedVideos.size > 0) {
        el.classList.remove('hidden');
        document.getElementById('selected-count').textContent = selectedVideos.size;
    } else {
        el.classList.add('hidden');
    }
}

function quickFilter(type, evt) {
    document.querySelectorAll('.quick-filter').forEach(b => b.classList.remove('active'));
    
    // Get dates in local timezone
    const now = new Date();
    const today = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
    const yesterdayDate = new Date(now);
    yesterdayDate.setDate(yesterdayDate.getDate() - 1);
    const yesterday = yesterdayDate.getFullYear() + '-' + String(yesterdayDate.getMonth()+1).padStart(2,'0') + '-' + String(yesterdayDate.getDate()).padStart(2,'0');
    const weekDate = new Date(now);
    weekDate.setDate(weekDate.getDate() - 7);
    const week = weekDate.getFullYear() + '-' + String(weekDate.getMonth()+1).padStart(2,'0') + '-' + String(weekDate.getDate()).padStart(2,'0');
    
    // Clear filters but don't reload yet
    document.getElementById('vid-camera').value = '';
    document.getElementById('vid-group').value = '';
    document.getElementById('vid-date-from').value = '';
    document.getElementById('vid-date-to').value = '';
    document.getElementById('vid-tag').value = '';
    window.starredFilter = false;
    videoPage = 1;
    
    // Add active class to clicked button
    if (evt && evt.target) {
        evt.target.classList.add('active');
    }
    
    if (type === 'today') {
        document.getElementById('vid-date-from').value = today;
        document.getElementById('vid-date-to').value = today;
    } else if (type === 'yesterday') {
        document.getElementById('vid-date-from').value = yesterday;
        document.getElementById('vid-date-to').value = yesterday;
    } else if (type === 'week') {
        document.getElementById('vid-date-from').value = week;
        document.getElementById('vid-date-to').value = today;
    } else if (type === 'starred') {
        window.starredFilter = true;
    }
    loadVideos();
}

function clearFilters() {
    document.getElementById('vid-camera').value = '';
    document.getElementById('vid-group').value = '';
    document.getElementById('vid-date-from').value = '';
    document.getElementById('vid-date-to').value = '';
    document.getElementById('vid-tag').value = '';
    window.starredFilter = false;
    document.querySelectorAll('.quick-filter').forEach(b => b.classList.remove('active'));
    videoPage = 1;
}

function openVideoModal(idx) {
    currentVideo = videos[idx];
    document.getElementById('video-modal').classList.add('active');
    document.getElementById('video-title').textContent = currentVideo.camera_name;
    const player = document.getElementById('video-player');
    player.src = '/api/local-videos/' + currentVideo.id + '/stream';
    player.playbackRate = 1;
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.toggle('active', b.textContent === '1x'));
    document.getElementById('vid-camera-name').textContent = currentVideo.camera_name;
    document.getElementById('vid-datetime').textContent = formatDateTime(currentVideo.created_at);
    document.getElementById('vid-duration').textContent = formatDuration(currentVideo.duration);
    document.getElementById('vid-size').textContent = formatBytes(currentVideo.file_size);
    document.getElementById('star-text').textContent = currentVideo.starred ? '‚òÖ Starred' : '‚òÜ Star';
    document.getElementById('vid-notes').value = currentVideo.notes || '';
    document.getElementById('vid-download-link').href = '/api/local-videos/' + currentVideo.id + '/download';
    renderVideoTags();
}

function renderVideoTags() {
    const el = document.getElementById('vid-tags');
    const vidTags = currentVideo.tags || [];
    el.innerHTML = vidTags.map(t => 
        '<span class="tag-pill" style="background:' + (t.color || '#3b82f6') + '30;color:' + (t.color || '#3b82f6') + '">' + 
        (typeof t === 'string' ? t : t.name) + '</span>'
    ).join('') + '<span class="tag-pill add-tag-btn" onclick="openAddTagModal()">+ Add</span>';
}

async function toggleStar() {
    if (!currentVideo) return;
    const newState = !currentVideo.starred;
    try {
        await fetch('/api/local-videos/' + currentVideo.id + '/star?starred=' + newState, {method: 'POST'});
        currentVideo.starred = newState;
        document.getElementById('star-text').textContent = newState ? '‚òÖ Starred' : '‚òÜ Star';
        toast(newState ? 'Video starred' : 'Star removed', 'success');
        loadVideos();
    } catch (e) {
        toast('Failed to update', 'error');
    }
}

async function quickStar(id, idx) {
    if (demoMode) return;
    const v = videos[idx];
    const newState = !v.starred;
    try {
        await fetch('/api/local-videos/' + id + '/star?starred=' + newState, {method: 'POST'});
        v.starred = newState;
        renderVideos();
    } catch (e) {}
}

async function markReviewed() {
    if (!currentVideo) return;
    try {
        await fetch('/api/local-videos/' + currentVideo.id + '/review?reviewed=true', {method: 'POST'});
        toast('Marked as reviewed', 'success');
    } catch (e) {
        toast('Failed', 'error');
    }
}

async function deleteVideo() {
    if (!currentVideo || !confirm('Delete this video permanently?')) return;
    try {
        await fetch('/api/local-videos/' + currentVideo.id, {method: 'DELETE'});
        toast('Video deleted', 'success');
        closeModal('video-modal');
        loadVideos();
    } catch (e) {
        toast('Failed to delete', 'error');
    }
}

// === Camera/Sync Modals ===
function openCameraModal(name) {
    const cam = cameras.find(c => c.name === name);
    if (!cam) return;
    currentLiveViewCamera = null;
    document.getElementById('camera-modal').classList.add('active');
    document.getElementById('camera-title').textContent = name;
    
    // Signal bars HTML - show N/A if no data
    const hasSignal = cam.wifi_strength !== null && cam.wifi_strength !== undefined;
    const sig = hasSignal ? cam.wifi_strength : 0;
    const signalHtml = hasSignal ? 
        '<div class="signal-bars" style="display:inline-flex;vertical-align:middle">' +
        '<div class="bar ' + (sig >= 1 ? 'active' : '') + '"></div>' +
        '<div class="bar ' + (sig >= 2 ? 'active' : '') + '"></div>' +
        '<div class="bar ' + (sig >= 3 ? 'active' : '') + '"></div>' +
        '<div class="bar ' + (sig >= 4 ? 'active' : '') + '"></div></div>' :
        '<span style="color:var(--text-muted)">N/A</span>';
    
    // Power display - with color coding
    let powerText = (cam.power_display || '--').toUpperCase();
    const powerLower = (cam.power_display || '').toLowerCase();
    let powerColor = 'inherit';
    if (powerLower.includes('critical') || powerLower.includes('dead') || powerLower.includes('offline')) {
        powerColor = 'var(--danger)';
    } else if (powerLower.includes('low')) {
        powerColor = 'var(--warning)';
    } else if (powerLower.includes('good') || powerLower.includes('ok') || cam.power_source === 'usb') {
        powerColor = 'var(--success)';
    }
    // Choose icon based on power source and status
    const powerIcon = cam.online_status === 'offline' ? '‚ùå' : (cam.power_source === 'usb' ? 'üîå' : 'üîã');
    const powerHtml = '<span style="color:' + powerColor + '">' + powerIcon + ' ' + powerText + '</span>';
    
    // Check if camera is offline
    const isOffline = cam.online_status === 'offline';
    
    // Format last seen time from thumbnail age
    let lastSeenText = '';
    if (cam.thumbnail_age_hours !== null && cam.thumbnail_age_hours !== undefined) {
        const hours = cam.thumbnail_age_hours;
        if (hours < 1) lastSeenText = 'Less than 1 hour ago';
        else if (hours < 24) lastSeenText = Math.round(hours) + ' hours ago';
        else if (hours < 48) lastSeenText = '1 day ago';
        else lastSeenText = Math.round(hours / 24) + ' days ago';
    }
    
    const offlineBanner = isOffline ? 
        '<div style="background:rgba(239,68,68,0.15);border:1px solid var(--danger);border-radius:var(--radius);padding:0.75rem;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem">' +
        '<span style="font-size:1.25rem">‚ö´</span>' +
        '<div>' +
        '<div style="font-weight:600;color:var(--danger)">Camera Offline</div>' +
        '<div style="font-size:0.8rem;color:var(--text-muted)">' + 
            (cam.power_source === 'battery' ? 'Battery may need replacement' : 'Check network connection') +
            (lastSeenText ? ' ‚Ä¢ Last seen: ' + lastSeenText : '') +
        '</div>' +
        '</div></div>' : '';
    
    // Last activity - relative time
    let lastActivity = '--';
    if (cam.last_record) {
        const d = new Date(cam.last_record);
        const now = new Date();
        const diffMs = now - d;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        if (diffMins < 1) lastActivity = 'Just now';
        else if (diffMins < 60) lastActivity = diffMins + ' min ago';
        else if (diffHours < 24) lastActivity = diffHours + ' hr ago';
        else if (diffDays < 7) lastActivity = diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago';
        else lastActivity = d.toLocaleDateString();
    }
    
    document.getElementById('camera-body').innerHTML = 
        offlineBanner +
        '<div style="display:flex;gap:0.5rem;margin-bottom:1rem;border-bottom:1px solid var(--border);padding-bottom:0.5rem">' +
        '<button class="btn btn-sm btn-secondary cam-tab active" onclick="switchCamTab(\'view\',this)">üì∑ View</button>' +
        '<button class="btn btn-sm btn-secondary cam-tab" onclick="switchCamTab(\'settings\',this);loadCameraConfig(\'' + name + '\')">‚öôÔ∏è Settings</button>' +
        '<button class="btn btn-sm btn-secondary cam-tab" onclick="switchCamTab(\'info\',this)">‚ÑπÔ∏è Info</button>' +
        '</div>' +
        '<div id="cam-tab-view">' +
        '<div style="text-align:center;margin-bottom:1rem">' +
        '<img src="/api/camera/' + encodeURIComponent(name) + '/thumbnail?t=' + Date.now() + '" style="max-width:100%;max-height:400px;border-radius:8px;background:#000" onerror="this.style.display=\'none\'">' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;margin-bottom:1rem">' +
        '<div class="video-detail-item"><div class="label">Type</div><div class="value">' + (cam.camera_type || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Power</div><div class="value">' + powerHtml + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Temp</div><div class="value">' + (cam.temperature ? cam.temperature + '¬∞F' : '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Signal</div><div class="value">' + signalHtml + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Last Activity</div><div class="value">' + lastActivity + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Motion</div><div class="value">' + (cam.motion_enabled ? '‚úÖ On' : '‚ùå Off') + '</div></div>' +
        '</div>' +
        '<div style="display:flex;gap:0.75rem;flex-wrap:wrap">' +
        '<button class="btn btn-secondary" onclick="snapPicture(\'' + name + '\')">üì∏ Snap Picture</button>' +
        '<button class="btn btn-secondary" onclick="toggleMotion(\'' + name + '\',' + !cam.motion_enabled + ')">' + 
        (cam.motion_enabled ? 'üîï Disable Motion' : 'üîî Enable Motion') + '</button>' +
        '</div>' +
        '</div>' +
        '<div id="cam-tab-settings" style="display:none">' +
        '<div id="cam-settings-content"><div class="loading-spinner"><div class="spinner"></div>Loading settings...</div></div>' +
        '</div>' +
        '<div id="cam-tab-info" style="display:none">' +
        '<div id="cam-info-content">' +
        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem">' +
        '<div class="video-detail-item"><div class="label">Camera ID</div><div class="value" style="font-family:monospace;font-size:0.8rem">' + (cam.camera_id || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Online Status</div><div class="value" style="color:' + (isOffline ? 'var(--danger)' : 'var(--success)') + '">' + (isOffline ? '‚ö´ Offline' : 'üü¢ Online') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Network ID</div><div class="value" style="font-family:monospace;font-size:0.8rem">' + (cam.network_id || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Serial</div><div class="value" style="font-family:monospace;font-size:0.8rem">' + (cam.serial || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Sync Module</div><div class="value">' + (cam.sync_module || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Camera Type</div><div class="value">' + (cam.camera_type || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Product Type</div><div class="value">' + (cam.product_type || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Motion Enabled</div><div class="value">' + (cam.motion_enabled ? '‚úÖ Yes' : '‚ùå No') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Last Recording</div><div class="value">' + (cam.last_record ? new Date(cam.last_record).toLocaleString() : '--') + '</div></div>' +
        '</div>' +
        '<div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)">' +
        '<div class="label" style="margin-bottom:0.5rem;color:var(--text-muted);font-size:0.75rem;text-transform:uppercase">Power Details</div>' +
        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem">' +
        '<div class="video-detail-item"><div class="label">Status</div><div class="value" style="color:' + powerColor + '">' + powerHtml + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Battery State</div><div class="value">' + (cam.battery_state || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Voltage</div><div class="value">' + (cam.battery_voltage ? cam.battery_voltage + 'V' : '--') + '</div></div>' +
        '</div></div>' +
        '</div>' +
        '</div>';
}

function switchCamTab(tab, btn) {
    document.querySelectorAll('.cam-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('cam-tab-view').style.display = tab === 'view' ? 'block' : 'none';
    document.getElementById('cam-tab-settings').style.display = tab === 'settings' ? 'block' : 'none';
    document.getElementById('cam-tab-info').style.display = tab === 'info' ? 'block' : 'none';
}

async function loadCameraConfig(name) {
    if (demoMode) {
        document.getElementById('cam-settings-content').innerHTML = '<p style="color:var(--text-muted)">Camera settings not available in demo mode.</p>';
        return;
    }
    try {
        const r = await fetch('/api/camera/' + encodeURIComponent(name) + '/config');
        if (!r.ok) {
            const errData = await r.json().catch(() => ({}));
            throw new Error(errData.detail || 'HTTP ' + r.status);
        }
        const cfg = await r.json();
        
        // Map video quality to display text
        const qualityText = {saver: 'üìâ Saver (low bandwidth)', standard: 'üìä Standard', best: 'üìà Best (high quality)'}[cfg.video_quality] || cfg.video_quality || '--';
        const nightText = {auto: 'üåô Auto', on: 'üåô Always On', off: '‚òÄÔ∏è Off'}[cfg.night_vision] || cfg.night_vision || '--';
        
        document.getElementById('cam-settings-content').innerHTML = 
            '<div style="background:var(--bg-primary);border-radius:var(--radius);padding:1rem;margin-bottom:1rem">' +
            '<div style="display:flex;align-items:center;gap:0.5rem;color:var(--text-muted);font-size:0.85rem;margin-bottom:0.75rem">' +
            '<span>‚ÑπÔ∏è</span><span>Camera settings can only be changed in the official Blink app</span>' +
            '</div>' +
            '</div>' +
            '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem">' +
            '<div class="video-detail-item"><div class="label">Motion Sensitivity</div><div class="value" style="font-size:1.25rem">' + 
            '<span style="display:inline-flex;align-items:center;gap:0.5rem">' + (cfg.motion_sensitivity || '--') + '/10' +
            '<div style="flex:1;height:6px;background:var(--bg-hover);border-radius:3px;width:60px;overflow:hidden">' +
            '<div style="height:100%;width:' + ((cfg.motion_sensitivity || 5) * 10) + '%;background:var(--accent);border-radius:3px"></div></div></span></div></div>' +
            '<div class="video-detail-item"><div class="label">Clip Length</div><div class="value">' + (cfg.clip_length || '--') + ' seconds</div></div>' +
            '<div class="video-detail-item"><div class="label">Retrigger Time</div><div class="value">' + (cfg.retrigger_time || '--') + ' seconds</div></div>' +
            '<div class="video-detail-item"><div class="label">Video Quality</div><div class="value">' + qualityText + '</div></div>' +
            '<div class="video-detail-item"><div class="label">Night Vision</div><div class="value">' + nightText + '</div></div>' +
            '<div class="video-detail-item"><div class="label">Illuminator</div><div class="value">' + (cfg.illuminator_enable ? 'üí° Enabled' : 'üîÖ Disabled') + '</div></div>' +
            '</div>' +
            '<div style="margin-top:1.5rem;text-align:center">' +
            '<a href="https://blinkforhome.com" target="_blank" class="btn btn-secondary" style="text-decoration:none">' +
            'üì± Open Blink App to Change Settings</a>' +
            '</div>';
    } catch (e) {
        document.getElementById('cam-settings-content').innerHTML = '<p style="color:var(--text-muted)">Could not load camera settings. ' + e.message + '</p>';
    }
}

// Legacy save function - no longer used but kept for compatibility
async function saveCameraConfig(e, name) {
    e.preventDefault();
    toast('Camera settings can only be changed in the Blink app', 'info');
}

let currentLiveViewCamera = null;
let liveViewInterval = null;

async function startLiveView(name) {
    if (demoMode) { toast('Demo mode - Live view simulated', 'info'); return; }
    
    const btn = document.getElementById('live-btn');
    const badge = document.getElementById('live-badge');
    
    if (currentLiveViewCamera === name) {
        // Stop live view
        stopLiveView();
        return;
    }
    
    toast('Starting live view...', 'info');
    btn.textContent = '‚èπ Stop Live';
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-danger');
    badge.style.display = 'block';
    currentLiveViewCamera = name;
    
    try {
        // Start live view session
        await fetch('/api/camera/' + encodeURIComponent(name) + '/live-view/start', {method: 'POST'});
        
        // Start refresh loop
        liveViewInterval = setInterval(async () => {
            if (currentLiveViewCamera !== name) {
                clearInterval(liveViewInterval);
                return;
            }
            try {
                const r = await fetch('/api/camera/' + encodeURIComponent(name) + '/live-view/frame', {method: 'POST'});
                const d = await r.json();
                if (d.success) {
                    document.getElementById('camera-live-img').src = d.thumbnail_url;
                }
            } catch (e) {
                console.error('Live frame error:', e);
            }
        }, 1500);
        
    } catch (e) {
        toast('Failed to start live view', 'error');
        stopLiveView();
    }
}

function stopLiveView() {
    if (liveViewInterval) {
        clearInterval(liveViewInterval);
        liveViewInterval = null;
    }
    
    const btn = document.getElementById('live-btn');
    const badge = document.getElementById('live-badge');
    
    if (btn) {
        btn.textContent = 'üé• Live View';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-primary');
    }
    if (badge) {
        badge.style.display = 'none';
    }
    
    if (currentLiveViewCamera) {
        fetch('/api/camera/' + encodeURIComponent(currentLiveViewCamera) + '/live-view/stop', {method: 'POST'});
    }
    currentLiveViewCamera = null;
}

async function snapPicture(name) {
    if (demoMode) { toast('Demo mode', 'info'); return; }
    toast('Requesting snapshot...', 'info');
    try {
        await fetch('/api/camera/' + encodeURIComponent(name) + '/refresh-thumbnail', {method: 'POST'});
        toast('Snapshot requested - refreshing in 4s...', 'success');
        // Refresh after delay to allow camera to capture
        setTimeout(() => {
            loadCameras();
            // Also refresh modal image if open
            const modalImg = document.querySelector('#camera-modal .modal-body img');
            if (modalImg && document.getElementById('camera-modal').classList.contains('active')) {
                modalImg.src = '/api/camera/' + encodeURIComponent(name) + '/thumbnail?t=' + Date.now();
            }
        }, 4000);
    } catch (e) {
        toast('Failed', 'error');
    }
}

async function toggleMotion(name, enable) {
    if (demoMode) { toast('Demo mode', 'info'); return; }
    toast('Updating...', 'info');
    try {
        await fetch('/api/camera/' + encodeURIComponent(name) + '/toggle-motion?enable=' + enable, {method: 'POST'});
        toast('Motion ' + (enable ? 'enabled' : 'disabled'), 'success');
        setTimeout(loadCameras, 2000);
        closeModal('camera-modal');
    } catch (e) {
        toast('Failed', 'error');
    }
}

function openSyncModal(name) {
    const sync = syncModules.find(s => s.name === name);
    if (!sync) return;
    document.getElementById('sync-modal').classList.add('active');
    document.getElementById('sync-title').textContent = name;
    
    // Build sync module cameras list (cameras that actually use the sync module)
    let syncCameraListHtml = '';
    const syncCams = sync.sync_cameras || sync.cameras?.filter(c => {
        const cam = cameras.find(cam => cam.name === c);
        return !cam || !cam.camera_type || !cam.camera_type.toLowerCase().includes('mini');
    }) || [];
    
    if (syncCams.length) {
        syncCameraListHtml = '<div style="margin-top:1rem"><div class="label" style="margin-bottom:0.5rem;color:var(--text-muted);font-size:0.75rem;text-transform:uppercase">üì° Sync Module Cameras</div>' +
            '<div style="display:flex;flex-wrap:wrap;gap:0.5rem">' +
            syncCams.map(camName => 
                '<button class="btn btn-sm btn-secondary" onclick="closeModal(\'sync-modal\');openCameraModal(\'' + camName + '\')">' +
                'üì∑ ' + camName + '</button>'
            ).join('') +
            '</div></div>';
    }
    
    // Build Mini cameras list (don't require sync module)
    let miniCameraListHtml = '';
    const miniCams = sync.mini_cameras || sync.cameras?.filter(c => {
        const cam = cameras.find(cam => cam.name === c);
        return cam && cam.camera_type && cam.camera_type.toLowerCase().includes('mini');
    }) || [];
    
    if (miniCams.length) {
        miniCameraListHtml = '<div style="margin-top:1rem"><div class="label" style="margin-bottom:0.5rem;color:var(--text-muted);font-size:0.75rem;text-transform:uppercase">üîå Mini Cameras (WiFi only, no sync module needed)</div>' +
            '<div style="display:flex;flex-wrap:wrap;gap:0.5rem">' +
            miniCams.map(camName => 
                '<button class="btn btn-sm btn-ghost" onclick="closeModal(\'sync-modal\');openCameraModal(\'' + camName + '\')">' +
                'üì∑ ' + camName + '</button>'
            ).join('') +
            '</div></div>';
    }
    
    // Armed state styling - green when armed, red when disarmed
    const armColor = sync.armed ? 'var(--success)' : 'var(--danger)';
    const armText = sync.armed ? 'Armed' : 'Disarmed';
    
    // WiFi signal bars
    const wifiStrength = sync.wifi_strength || 0;
    const wifiHtml = wifiStrength ? 
        '<div class="signal-bars">' +
        '<div class="bar' + (wifiStrength >= 1 ? ' active' : '') + '"></div>' +
        '<div class="bar' + (wifiStrength >= 2 ? ' active' : '') + '"></div>' +
        '<div class="bar' + (wifiStrength >= 3 ? ' active' : '') + '"></div>' +
        '<div class="bar' + (wifiStrength >= 4 ? ' active' : '') + '"></div>' +
        '</div>' : '<span style="color:var(--text-muted)">--</span>';
    
    // Local storage status
    let storageHtml = '--';
    if (sync.local_storage_enabled !== null && sync.local_storage_enabled !== undefined) {
        if (sync.local_storage_enabled) {
            storageHtml = '<span style="color:var(--success)">‚úì Enabled</span>';
            if (sync.local_storage_status) {
                storageHtml += ' <span style="color:var(--text-muted)">(' + sync.local_storage_status + ')</span>';
            }
        } else {
            storageHtml = '<span style="color:var(--text-muted)">Not enabled</span>';
        }
    }
    
    document.getElementById('sync-body').innerHTML = 
        '<div class="video-details" style="grid-template-columns:repeat(3,1fr)">' +
        '<div class="video-detail-item"><div class="label">Status</div><div class="value" style="color:' + (sync.status === 'online' ? 'var(--success)' : 'var(--danger)') + '">' + (sync.status || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">WiFi Signal</div><div class="value">' + wifiHtml + '</div></div>' +
        '<div class="video-detail-item"><div class="label">WiFi Network</div><div class="value">' + (sync.wifi_ssid || '<span style="color:var(--text-muted)">--</span>') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Serial</div><div class="value" style="font-size:0.75rem">' + (sync.serial || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Network ID</div><div class="value">' + (sync.network_id || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Firmware</div><div class="value" style="font-size:0.75rem">' + (sync.fw_version || '--') + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Local Storage</div><div class="value">' + storageHtml + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Sync Cameras</div><div class="value">' + syncCams.length + '</div></div>' +
        '<div class="video-detail-item"><div class="label">Mini Cameras</div><div class="value">' + miniCams.length + '</div></div>' +
        '</div>' +
        '<div style="margin-top:1rem;padding:1rem;background:var(--bg-primary);border-radius:var(--radius);display:flex;align-items:center;justify-content:space-between">' +
        '<div><div style="font-weight:600;margin-bottom:0.25rem">System Status</div><span style="font-weight:600;color:' + armColor + '">' + armText + '</span></div>' +
        '<button class="btn btn-sm ' + (sync.armed ? 'btn-danger' : 'btn-primary') + '" onclick="toggleArmSyncModal(\'' + name + '\', ' + !sync.armed + ')">' +
        (sync.armed ? 'üîì Disarm' : 'üîí Arm') + '</button>' +
        '</div>' +
        syncCameraListHtml + miniCameraListHtml;
}

async function toggleArm(name, arm) {
    if (demoMode) { toast('Demo mode', 'info'); return; }
    toast('Updating...', 'info');
    try {
        await fetch('/api/sync/' + encodeURIComponent(name) + '/arm?arm=' + arm, {method: 'POST'});
        toast(arm ? 'Armed' : 'Disarmed', 'success');
        closeModal('sync-modal');
        setTimeout(loadCameras, 2000);
    } catch (e) {
        toast('Failed', 'error');
    }
}

async function toggleArmSync(name, arm) {
    if (demoMode) { toast('Demo mode', 'info'); return; }
    toast(arm ? 'Arming...' : 'Disarming...', 'info');
    try {
        const r = await fetch('/api/sync/' + encodeURIComponent(name) + '/arm?arm=' + arm, {method: 'POST'});
        const d = await r.json();
        if (d.success) {
            toast(arm ? 'System armed' : 'System disarmed', 'success');
            // Update local state
            const sync = syncModules.find(s => s.name === name);
            if (sync) sync.armed = arm;
            renderSyncModules();
        } else {
            toast(d.detail || 'Failed', 'error');
            // Revert checkbox
            renderSyncModules();
        }
    } catch (e) {
        toast('Failed to ' + (arm ? 'arm' : 'disarm'), 'error');
        renderSyncModules();
    }
}

async function toggleArmSyncModal(name, arm) {
    if (demoMode) { toast('Demo mode', 'info'); return; }
    toast(arm ? 'Arming...' : 'Disarming...', 'info');
    try {
        const r = await fetch('/api/sync/' + encodeURIComponent(name) + '/arm?arm=' + arm, {method: 'POST'});
        const d = await r.json();
        if (d.success) {
            toast(arm ? 'System armed' : 'System disarmed', 'success');
            // Update local state
            const sync = syncModules.find(s => s.name === name);
            if (sync) sync.armed = arm;
            // Refresh the modal
            openSyncModal(name);
            renderSyncModules();
        } else {
            toast(d.detail || 'Failed', 'error');
            // Refresh to revert
            openSyncModal(name);
        }
    } catch (e) {
        toast('Failed to ' + (arm ? 'arm' : 'disarm'), 'error');
        openSyncModal(name);
    }
}

async function refreshAllThumbnails() {
    if (demoMode) { toast('Demo mode', 'info'); return; }
    toast('Requesting all thumbnails...', 'info');
    try {
        await fetch('/api/cameras/refresh-all-thumbnails', {method: 'POST'});
        toast('Thumbnails requested', 'success');
        setTimeout(loadCameras, 5000);
    } catch (e) {
        toast('Failed', 'error');
    }
}

async function applyBulkTag() {
    const tagId = document.getElementById('bulk-tag-select').value;
    if (!tagId) return;
    
    try {
        await fetch('/api/local-videos/bulk-tag', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({video_ids: Array.from(selectedVideos), tag_id: parseInt(tagId)})
        });
        toast('Tags applied', 'success');
        closeModal('bulk-tag-modal');
        clearSelection();
        loadVideos();
    } catch (e) {
        toast('Failed to apply tags', 'error');
    }
}

async function bulkDeleteVideos() {
    if (!selectedVideos.size) return;
    if (!confirm('Delete ' + selectedVideos.size + ' videos permanently?')) return;
    
    try {
        await fetch('/api/local-videos/bulk-delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({video_ids: Array.from(selectedVideos)})
        });
        toast('Videos deleted', 'success');
        clearSelection();
        loadVideos();
    } catch (e) {
        toast('Failed to delete', 'error');
    }
}

// Toggle health list visibility
function toggleHealthList(listType) {
    const lists = ['healthy', 'lowbattery', 'weaksignal', 'motionoff'];
    const targetList = document.getElementById('health-list-' + listType);
    const isVisible = targetList && targetList.style.display !== 'none';
    
    // Hide all lists first
    lists.forEach(l => {
        const el = document.getElementById('health-list-' + l);
        if (el) el.style.display = 'none';
    });
    
    // Toggle the clicked list
    if (targetList && !isVisible) {
        targetList.style.display = 'block';
    }
}

// === Navigation ===
function switchTab(tab) {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector('[onclick="switchTab(\'' + tab + '\')"]').classList.add('active');
    document.getElementById('tab-' + tab).classList.add('active');
    
    // Save current section for page refresh persistence
    localStorage.setItem('lastSection', tab);
    
    const titles = {dashboard: 'Dashboard', cameras: 'Cameras', sync: 'Sync Modules', videos: 'Videos', downloads: 'Downloads', logs: 'Logs', settings: 'Settings'};
    document.getElementById('page-title').textContent = titles[tab] || tab;
    
    if (tab === 'videos') {
        // Default to Today filter if no filter is set
        const dateFrom = document.getElementById('vid-date-from').value;
        if (!dateFrom) {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('vid-date-from').value = today;
            document.getElementById('vid-date-to').value = today;
            // Set Today button as active
            const todayBtn = document.querySelector('.quick-filter[onclick*="today"]');
            if (todayBtn) todayBtn.classList.add('active');
        }
        loadVideos();
    }
    if (tab === 'settings') {
        loadTagsAndGroups();
        loadTimezones();
    }
    if (tab === 'cameras') populateCameraGroupFilter();
    if (tab === 'logs') {
        loadLogs();
        // Auto-enable autorefresh for logs
        if (!logAutoRefresh) toggleAutoRefresh();
    } else {
        // Stop autorefresh when leaving logs tab
        if (logAutoRefresh) {
            clearInterval(logAutoRefresh);
            logAutoRefresh = null;
            const btn = document.getElementById('auto-refresh-btn');
            const status = document.getElementById('auto-refresh-status');
            if (btn) { btn.textContent = '‚ñ∂ Auto'; btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary'); }
            if (status) status.textContent = 'Off';
        }
    }
}

// === Logs ===
let logAutoRefresh = null;

async function loadLogs() {
    const viewer = document.getElementById('log-viewer');
    const level = document.getElementById('log-level-filter')?.value || '';
    
    try {
        const url = '/api/logs?count=500' + (level ? '&level=' + level : '');
        const r = await fetch(url);
        const d = await r.json();
        
        if (!d.logs || d.logs.length === 0) {
            viewer.innerHTML = '<div class="log-empty">No log entries</div>';
            document.getElementById('log-count').textContent = '0';
            return;
        }
        
        const wasScrolledToBottom = viewer.scrollHeight - viewer.clientHeight <= viewer.scrollTop + 50;
        
        viewer.innerHTML = d.logs.map(log => {
            const level = log.level || 'INFO';
            return '<div class="log-entry ' + level + '">' +
                '<span class="level">[' + level + ']</span> ' +
                log.message +
                '</div>';
        }).join('');
        
        document.getElementById('log-count').textContent = d.total || d.logs.length;
        
        // Auto-scroll to bottom if was at bottom
        if (wasScrolledToBottom) {
            viewer.scrollTop = viewer.scrollHeight;
        }
    } catch (e) {
        viewer.innerHTML = '<div class="log-empty">Failed to load logs: ' + e.message + '</div>';
    }
}

function toggleAutoRefresh() {
    const btn = document.getElementById('auto-refresh-btn');
    const status = document.getElementById('auto-refresh-status');
    
    if (logAutoRefresh) {
        clearInterval(logAutoRefresh);
        logAutoRefresh = null;
        btn.textContent = '‚ñ∂ Auto';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
        status.textContent = 'Off';
    } else {
        logAutoRefresh = setInterval(loadLogs, 2000);
        btn.textContent = '‚è∏ Auto';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
        status.textContent = 'On (2s)';
        loadLogs(); // Load immediately
    }
}

async function clearLogs() {
    if (!confirm('Clear all logs from buffer?')) return;
    try {
        await fetch('/api/logs/clear', {method: 'POST'});
        toast('Logs cleared', 'success');
        loadLogs();
    } catch (e) {
        toast('Failed to clear logs', 'error');
    }
}

function refreshAll() {
    if (demoMode) { toast('Demo mode', 'info'); return; }
    toast('Refreshing...', 'info');
    loadStatus();
    loadCameras();
    loadVideos();
}

async function openFolder() {
    try {
        await fetch('/api/open-folder', {method: 'POST'});
    } catch (e) {}
}

async function browseFolder() {
    const path = prompt('Enter download folder path:');
    if (!path) return;
    
    try {
        const r = await fetch('/api/settings');
        const settings = await r.json();
        settings.download_dir = path;
        await fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(settings)
        });
        document.getElementById('storage-path').textContent = path;
        toast('Folder updated', 'success');
    } catch (e) {
        toast('Failed to update folder', 'error');
    }
}

async function regenerateThumbnails() {
    if (!confirm('Regenerate thumbnails for all videos? This requires ffmpeg to be installed.')) return;
    
    try {
        toast('Starting thumbnail regeneration...', 'info');
        const r = await fetch('/api/local-videos/regenerate-thumbnails', {method: 'POST'});
        const d = await r.json();
        if (d.success) {
            toast('Thumbnail regeneration started in background. Check logs for progress.', 'success');
        } else {
            toast(d.message || 'Failed to start regeneration', 'error');
        }
    } catch (e) {
        toast('Error: ' + e.message, 'error');
    }
}

// Timezone Functions
async function loadTimezones() {
    try {
        const r = await fetch('/api/timezones');
        const d = await r.json();
        const select = document.getElementById('timezone-select');
        if (!select) return;
        
        select.innerHTML = '';
        for (const tz of d.timezones) {
            const opt = document.createElement('option');
            opt.value = tz.value;
            opt.textContent = tz.label;
            if (tz.value === d.current) opt.selected = true;
            select.appendChild(opt);
        }
        
        // If auto is selected, show detected timezone
        if (d.current === 'auto') {
            const detected = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const autoOpt = select.querySelector('option[value="auto"]');
            if (autoOpt) autoOpt.textContent = 'Auto-detect (' + detected + ')';
        }
        
        // Show warning if tzdata not available
        const tzWarning = document.getElementById('tz-warning');
        if (tzWarning) {
            if (d.tzdata_available === false) {
                tzWarning.style.display = 'block';
            } else {
                tzWarning.style.display = 'none';
            }
        }
        
        // Load legacy video count
        loadLegacyVideoCount();
    } catch (e) {
        console.error('Error loading timezones:', e);
    }
}

async function saveTimezone() {
    const select = document.getElementById('timezone-select');
    const timezone = select?.value || 'auto';
    
    try {
        // Get current settings and update timezone
        const r = await fetch('/api/settings');
        const d = await r.json();
        const settings = d.settings;
        settings.timezone = timezone;
        
        // Save settings
        const r2 = await fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(settings)
        });
        
        if (r2.ok) {
            toast('Timezone saved', 'success');
            // Update auto-detect label if needed
            if (timezone === 'auto') {
                const detected = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const autoOpt = select.querySelector('option[value="auto"]');
                if (autoOpt) autoOpt.textContent = 'Auto-detect (' + detected + ')';
            }
        } else {
            toast('Failed to save timezone', 'error');
        }
    } catch (e) {
        toast('Error: ' + e.message, 'error');
    }
}

async function loadLegacyVideoCount() {
    try {
        const r = await fetch('/api/legacy-video-count');
        const d = await r.json();
        const desc = document.getElementById('legacy-video-desc');
        const btn = document.getElementById('rename-videos-btn');
        
        if (d.count > 0) {
            desc.textContent = d.count + ' videos with UTC filenames can be renamed';
            btn.disabled = false;
        } else {
            desc.textContent = 'All videos already use local timezone filenames';
            btn.disabled = true;
        }
    } catch (e) {
        console.error('Error loading legacy video count:', e);
    }
}

async function renameVideosToLocalTime() {
    const select = document.getElementById('timezone-select');
    let timezone = select?.value || 'auto';
    
    // If auto, use browser timezone
    if (timezone === 'auto') {
        timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    }
    
    if (!confirm('Rename all legacy UTC video files to use ' + timezone + ' timezone?\n\nThis will rename the actual files on disk.')) {
        return;
    }
    
    const btn = document.getElementById('rename-videos-btn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = '‚è≥ Renaming...';
    
    try {
        const r = await fetch('/api/rename-videos-to-local-time', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({timezone: timezone})
        });
        const d = await r.json();
        
        if (d.success) {
            toast(d.message, d.errors > 0 ? 'warning' : 'success');
            loadLegacyVideoCount(); // Refresh count
            loadVideos(); // Refresh video list
        } else {
            toast(d.detail || 'Failed to rename videos', 'error');
        }
    } catch (e) {
        toast('Error: ' + e.message, 'error');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

async function checkCloudParity() {
    const resultsEl = document.getElementById('parity-results');
    resultsEl.style.display = 'block';
    resultsEl.innerHTML = '<div style="display:flex;align-items:center;gap:0.5rem;color:var(--text-muted)"><div class="spinner" style="width:16px;height:16px;border-width:2px"></div> Checking cloud vs local videos...</div>';
    
    try {
        const r = await fetch('/api/cloud-parity');
        const d = await r.json();
        
        if (d.error) {
            resultsEl.innerHTML = '<div style="color:var(--danger)">‚ö†Ô∏è ' + d.error + '</div>';
            return;
        }
        
        const cloudCount = d.cloud_count || 0;
        const localCount = d.local_count || 0;
        const missingCount = d.missing_count || 0;
        const missingList = d.missing || [];
        
        let html = '<div style="background:var(--bg-primary);padding:1rem;border-radius:var(--radius);font-size:0.85rem">';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;text-align:center;margin-bottom:1rem">';
        html += '<div><div style="font-size:1.5rem;font-weight:700;color:var(--accent)">' + cloudCount + '</div><div style="color:var(--text-muted)">In Cloud</div></div>';
        html += '<div><div style="font-size:1.5rem;font-weight:700;color:var(--success)">' + localCount + '</div><div style="color:var(--text-muted)">Downloaded</div></div>';
        html += '<div><div style="font-size:1.5rem;font-weight:700;color:' + (missingCount > 0 ? 'var(--warning)' : 'var(--success)') + '">' + missingCount + '</div><div style="color:var(--text-muted)">Missing</div></div>';
        html += '</div>';
        
        if (missingCount === 0) {
            html += '<div style="text-align:center;color:var(--success)">‚úÖ All cloud videos are downloaded locally!</div>';
        } else {
            html += '<div style="color:var(--warning);margin-bottom:0.5rem">‚ö†Ô∏è ' + missingCount + ' videos in cloud not yet downloaded</div>';
            html += '<button class="btn btn-primary" style="margin-bottom:0.75rem" onclick="downloadMissingVideos()">‚¨áÔ∏è Download Missing Videos</button>';
            if (missingList.length > 0) {
                html += '<details><summary style="cursor:pointer;color:var(--text-muted)">Show missing videos</summary>';
                html += '<div style="max-height:150px;overflow-y:auto;margin-top:0.5rem;font-size:0.75rem">';
                missingList.slice(0, 50).forEach(v => {
                    html += '<div style="padding:0.25rem 0;border-bottom:1px solid var(--border)">' + v.camera + ' - ' + v.date + '</div>';
                });
                if (missingList.length > 50) html += '<div style="color:var(--text-muted)">...and ' + (missingList.length - 50) + ' more</div>';
                html += '</div></details>';
            }
        }
        html += '</div>';
        resultsEl.innerHTML = html;
        
    } catch (e) {
        resultsEl.innerHTML = '<div style="color:var(--danger)">‚ö†Ô∏è Error checking parity: ' + e.message + '</div>';
    }
}

async function downloadMissingVideos() {
    if (demoMode) { toast('Demo mode - downloads disabled', 'info'); return; }
    
    if (!confirm('Download all missing videos from the cloud? This may take a while depending on how many videos are missing.')) {
        return;
    }
    
    const resultsEl = document.getElementById('parity-results');
    resultsEl.innerHTML = '<div style="display:flex;align-items:center;gap:0.5rem;color:var(--text-muted)"><div class="spinner" style="width:16px;height:16px;border-width:2px"></div> Starting download of missing videos...</div>';
    
    try {
        const r = await fetch('/api/download-missing', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                browser_timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            })
        });
        
        if (r.ok) {
            const d = await r.json();
            toast('Download of missing videos started', 'success');
            
            // Show inline progress in the cloud parity results area
            resultsEl.innerHTML = `
                <div style="background:var(--bg-primary);padding:1rem;border-radius:var(--radius)">
                    <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem">
                        <div class="spinner" style="width:16px;height:16px;border-width:2px"></div>
                        <span style="font-weight:600">Downloading ${d.missing_count || 'missing'} videos...</span>
                    </div>
                    <div id="missing-dl-progress">
                        <div style="background:var(--bg-secondary);border-radius:4px;height:8px;overflow:hidden;margin-bottom:0.5rem">
                            <div id="missing-dl-bar" style="background:var(--accent);height:100%;width:0%;transition:width 0.3s"></div>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:0.8rem;color:var(--text-muted)">
                            <span id="missing-dl-status">Starting...</span>
                            <span id="missing-dl-count">0/0</span>
                        </div>
                    </div>
                    <div style="margin-top:0.75rem;text-align:center">
                        <button class="btn btn-sm btn-secondary" onclick="showSection('videos')">View in Videos Tab</button>
                    </div>
                </div>
            `;
            
            // Start polling for progress
            pollMissingDownloadStatus();
        } else {
            const d = await r.json();
            resultsEl.innerHTML = '<div style="color:var(--danger)">‚ö†Ô∏è ' + (d.detail || 'Error starting download') + '</div>';
        }
    } catch (e) {
        resultsEl.innerHTML = '<div style="color:var(--danger)">‚ö†Ô∏è Error: ' + e.message + '</div>';
    }
}

async function pollMissingDownloadStatus() {
    try {
        const r = await fetch('/api/download/status');
        const d = await r.json();
        
        const barEl = document.getElementById('missing-dl-bar');
        const statusEl = document.getElementById('missing-dl-status');
        const countEl = document.getElementById('missing-dl-count');
        const resultsEl = document.getElementById('parity-results');
        
        if (!barEl) return; // User navigated away
        
        const total = d.total || 0;
        const done = (d.downloaded || 0) + (d.skipped || 0);
        const pct = total > 0 ? Math.round((done / total) * 100) : 0;
        
        barEl.style.width = pct + '%';
        statusEl.textContent = d.current_camera || d.current_file || 'Processing...';
        countEl.textContent = `${d.downloaded || 0} downloaded, ${d.skipped || 0} skipped / ${total}`;
        
        if (d.running) {
            setTimeout(pollMissingDownloadStatus, 1000);
        } else {
            // Download complete
            const bytes = d.bytes_downloaded || 0;
            const bytesStr = bytes > 1024*1024 ? (bytes/1024/1024).toFixed(1) + ' MB' : (bytes/1024).toFixed(1) + ' KB';
            
            resultsEl.innerHTML = `
                <div style="background:var(--bg-primary);padding:1rem;border-radius:var(--radius);text-align:center">
                    <div style="font-size:1.5rem;margin-bottom:0.5rem">${d.error ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                    <div style="font-weight:600;margin-bottom:0.25rem">${d.error ? 'Download Error' : 'Download Complete'}</div>
                    <div style="color:var(--text-muted);font-size:0.85rem">
                        ${d.downloaded || 0} videos downloaded (${bytesStr}), ${d.skipped || 0} skipped
                    </div>
                    ${d.error ? '<div style="color:var(--danger);margin-top:0.5rem;font-size:0.8rem">' + d.error + '</div>' : ''}
                    <button class="btn btn-sm btn-secondary" style="margin-top:0.75rem" onclick="checkCloudParity()">üîÑ Check Again</button>
                </div>
            `;
        }
    } catch (e) {
        console.error('Error polling download status:', e);
        setTimeout(pollMissingDownloadStatus, 2000);
    }
}

// === Downloads ===
async function startDownload() {
    if (demoMode) { toast('Demo mode - downloads disabled', 'info'); return; }
    
    const days = parseInt(document.getElementById('dl-days').value) || 7;
    document.getElementById('dl-progress').classList.remove('hidden');
    document.getElementById('dl-status').textContent = 'Starting...';
    document.getElementById('dl-bar').style.width = '0%';
    document.getElementById('dl-count').textContent = '0/0';
    document.getElementById('dl-current').textContent = '';
    document.getElementById('dl-btn').disabled = true;
    
    // Get browser timezone for filename conversion
    const browserTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    
    try {
        const r = await fetch('/api/download', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                since_days: days,
                browser_timezone: browserTimezone
            })
        });
        if (r.ok) {
            toast('Download started', 'success');
            pollDownloadStatus();
            checkDownloadStatus(); // Also update the Videos tab banner
        } else {
            const d = await r.json();
            toast(d.detail || 'Failed to start', 'error');
            document.getElementById('dl-btn').disabled = false;
        }
    } catch (e) {
        toast('Failed to start download', 'error');
        document.getElementById('dl-btn').disabled = false;
    }
}

async function pollDownloadStatus() {
    try {
        const r = await fetch('/api/status');
        const d = await r.json();
        const dl = d.download_status || {};
        
        if (dl.running) {
            document.getElementById('dl-status').textContent = dl.current_camera || 'Downloading...';
            document.getElementById('dl-count').textContent = (dl.downloaded || 0) + '/' + (dl.total || 0);
            const pct = dl.total ? Math.round((dl.downloaded / dl.total) * 100) : 0;
            document.getElementById('dl-bar').style.width = pct + '%';
            document.getElementById('dl-current').textContent = dl.current_file || '';
            setTimeout(pollDownloadStatus, 1000);
        } else {
            document.getElementById('dl-status').textContent = 'Complete';
            document.getElementById('dl-bar').style.width = '100%';
            document.getElementById('dl-btn').disabled = false;
            toast('Download complete', 'success');
            loadVideos();
            loadStatus();
        }
    } catch (e) {
        document.getElementById('dl-btn').disabled = false;
    }
}

// === Sync Toggle ===
async function toggleSync() {
    if (demoMode) { toast('Demo mode - sync disabled', 'info'); return; }
    
    const toggle = document.getElementById('toggle-sync');
    const newState = !toggle.classList.contains('active');
    const interval = parseInt(document.getElementById('sync-interval').value) || 5;
    
    try {
        const r = await fetch('/api/sync/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({enabled: newState, interval_minutes: interval})
        });
        if (r.ok) {
            toggle.classList.toggle('active', newState);
            toast(newState ? 'Auto-sync enabled' : 'Auto-sync disabled', 'success');
        } else {
            toast('Failed to update sync settings', 'error');
        }
    } catch (e) {
        toast('Failed to update sync', 'error');
    }
}

async function updateSyncInterval() {
    if (demoMode) return;
    const enabled = document.getElementById('toggle-sync').classList.contains('active');
    if (!enabled) return;
    
    const interval = parseInt(document.getElementById('sync-interval').value) || 5;
    try {
        await fetch('/api/sync/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({enabled: true, interval_minutes: interval})
        });
        toast('Sync interval updated', 'success');
    } catch (e) {}
}

// === Tags ===
function renderTags() {
    const el = document.getElementById('tags-list');
    if (!tags.length) {
        el.innerHTML = '<p style="color:var(--text-muted);font-size:0.85rem">No tags created yet</p>';
        return;
    }
    el.innerHTML = tags.map(t => 
        '<div class="setting-row">' +
        '<div><span class="tag-pill" style="background:' + (t.color || '#3b82f6') + '30;color:' + (t.color || '#3b82f6') + '">' + t.name + '</span>' +
        '<span style="font-size:0.7rem;color:var(--text-muted);margin-left:0.5rem">' + (t.video_count || 0) + ' videos</span></div>' +
        '<div style="display:flex;gap:0.25rem"><button class="btn btn-sm btn-ghost" onclick="editTag(' + t.id + ')">Edit</button>' +
        '<button class="btn btn-sm btn-ghost" onclick="deleteTag(' + t.id + ')">üóë</button></div></div>'
    ).join('');
}

function openTagModal(tagId = null) {
    editingTagId = tagId;
    if (tagId) {
        const tag = tags.find(t => t.id === tagId);
        if (tag) {
            document.getElementById('tag-modal-title').textContent = 'Edit Tag';
            document.getElementById('tag-name').value = tag.name;
            document.getElementById('tag-color').value = tag.color || '#3b82f6';
        }
    } else {
        document.getElementById('tag-modal-title').textContent = 'New Tag';
        document.getElementById('tag-name').value = '';
        document.getElementById('tag-color').value = '#3b82f6';
    }
    document.getElementById('tag-modal').classList.add('active');
}

function editTag(id) {
    openTagModal(id);
}

async function saveTag() {
    if (demoMode) { toast('Demo mode', 'info'); closeModal('tag-modal'); return; }
    
    const name = document.getElementById('tag-name').value.trim();
    const color = document.getElementById('tag-color').value;
    if (!name) { toast('Enter a tag name', 'error'); return; }
    
    try {
        const url = editingTagId ? '/api/tags/' + editingTagId : '/api/tags';
        const method = editingTagId ? 'PUT' : 'POST';
        
        const r = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name, color: color})
        });
        
        if (r.ok) {
            toast(editingTagId ? 'Tag updated' : 'Tag created', 'success');
            closeModal('tag-modal');
            await loadTagsAndGroups();
        } else {
            toast('Failed to save tag', 'error');
        }
    } catch (e) {
        toast('Failed to save tag', 'error');
    }
}

async function deleteTag(id) {
    if (demoMode) { toast('Demo mode', 'info'); return; }
    if (!confirm('Delete this tag?')) return;
    
    try {
        const r = await fetch('/api/tags/' + id, {method: 'DELETE'});
        if (r.ok) {
            toast('Tag deleted', 'success');
            await loadTagsAndGroups();
        } else {
            toast('Failed to delete tag', 'error');
        }
    } catch (e) {
        toast('Failed to delete', 'error');
    }
}

function openAddTagModal() {
    if (!tags.length) {
        toast('Create a tag first in Settings', 'info');
        return;
    }
    document.getElementById('add-tag-select').innerHTML = tags.map(t => 
        '<option value="' + t.id + '">' + t.name + '</option>'
    ).join('');
    document.getElementById('add-tag-modal').classList.add('active');
}

async function addTagToVideo() {
    if (!currentVideo) return;
    const tagId = document.getElementById('add-tag-select').value;
    if (!tagId) return;
    
    try {
        const r = await fetch('/api/local-videos/' + currentVideo.id + '/tags/' + tagId, {method: 'POST'});
        if (r.ok) {
            const tag = tags.find(t => t.id == tagId);
            if (tag) {
                currentVideo.tags = currentVideo.tags || [];
                currentVideo.tags.push(tag);
                renderVideoTags();
            }
            toast('Tag added', 'success');
            closeModal('add-tag-modal');
        } else {
            toast('Failed to add tag', 'error');
        }
    } catch (e) {
        toast('Failed to add tag', 'error');
    }
}

// === Camera Groups ===
function renderGroups() {
    const el = document.getElementById('groups-list');
    if (!groups.length) {
        el.innerHTML = '<p style="color:var(--text-muted);font-size:0.85rem">No groups created yet</p>';
        return;
    }
    el.innerHTML = groups.map(g => 
        '<div class="setting-row">' +
        '<div><span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:' + (g.color || '#6b7280') + ';margin-right:0.5rem"></span>' +
        '<strong>' + g.name + '</strong><span style="font-size:0.7rem;color:var(--text-muted);margin-left:0.5rem">' + (g.cameras ? g.cameras.length : 0) + ' cameras</span></div>' +
        '<div style="display:flex;gap:0.25rem"><button class="btn btn-sm btn-ghost" onclick="editGroup(' + g.id + ')">Edit</button>' +
        '<button class="btn btn-sm btn-ghost" onclick="deleteGroup(' + g.id + ')">üóë</button></div></div>'
    ).join('');
}

function openGroupModal(groupId = null) {
    editingGroupId = groupId;
    
    // Populate camera list
    const camList = document.getElementById('group-cameras');
    let selectedCams = [];
    
    if (groupId) {
        const group = groups.find(g => g.id === groupId);
        if (group) {
            document.getElementById('group-modal-title').textContent = 'Edit Group';
            document.getElementById('group-name').value = group.name;
            document.getElementById('group-color').value = group.color || '#6b7280';
            selectedCams = group.cameras || [];
        }
    } else {
        document.getElementById('group-modal-title').textContent = 'New Group';
        document.getElementById('group-name').value = '';
        document.getElementById('group-color').value = '#6b7280';
    }
    
    camList.innerHTML = cameras.length ? cameras.map(c => 
        '<label style="display:flex;align-items:center;gap:0.5rem;padding:0.25rem 0;cursor:pointer">' +
        '<input type="checkbox" value="' + c.name + '"' + (selectedCams.includes(c.name) ? ' checked' : '') + '> ' + c.name + '</label>'
    ).join('') : '<p style="color:var(--text-muted)">No cameras available</p>';
    
    document.getElementById('group-modal').classList.add('active');
}

function editGroup(id) {
    openGroupModal(id);
}

async function saveGroup() {
    if (demoMode) { toast('Demo mode', 'info'); closeModal('group-modal'); return; }
    
    const name = document.getElementById('group-name').value.trim();
    const color = document.getElementById('group-color').value;
    const selectedCams = Array.from(document.querySelectorAll('#group-cameras input:checked')).map(i => i.value);
    
    if (!name) { toast('Enter a group name', 'error'); return; }
    
    try {
        const url = editingGroupId ? '/api/camera-groups/' + editingGroupId : '/api/camera-groups';
        const method = editingGroupId ? 'PUT' : 'POST';
        
        const r = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name, color: color, cameras: selectedCams})
        });
        
        if (r.ok) {
            toast(editingGroupId ? 'Group updated' : 'Group created', 'success');
            closeModal('group-modal');
            await loadTagsAndGroups();
        } else {
            toast('Failed to save group', 'error');
        }
    } catch (e) {
        toast('Failed to save group', 'error');
    }
}

async function deleteGroup(id) {
    if (demoMode) { toast('Demo mode', 'info'); return; }
    if (!confirm('Delete this camera group?')) return;
    
    try {
        const r = await fetch('/api/camera-groups/' + id, {method: 'DELETE'});
        if (r.ok) {
            toast('Group deleted', 'success');
            await loadTagsAndGroups();
        } else {
            toast('Failed to delete group', 'error');
        }
    } catch (e) {
        toast('Failed to delete', 'error');
    }
}

// === Bulk Tag ===
function bulkTagVideos() {
    if (!selectedVideos.size) return;
    if (!tags.length) { toast('Create a tag first in Settings', 'info'); return; }
    
    document.getElementById('bulk-count').textContent = selectedVideos.size;
    document.getElementById('bulk-tag-select').innerHTML = tags.map(t => 
        '<option value="' + t.id + '">' + t.name + '</option>'
    ).join('');
    document.getElementById('bulk-tag-modal').classList.add('active');
}

// === Init ===
document.addEventListener('keydown', e => {
    // Don't capture if typing in input/textarea
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
    
    const videoModal = document.getElementById('video-modal');
    const player = document.getElementById('video-player');
    const isVideoModalOpen = videoModal.classList.contains('active');
    
    // Escape - close modals
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        player.src = '';
        currentVideo = null;
        return;
    }
    
    // Video modal controls
    if (isVideoModalOpen) {
        if (e.key === ' ' || e.key === 'k') {
            e.preventDefault();
            player.paused ? player.play() : player.pause();
        } else if (e.key === 'j') {
            player.currentTime = Math.max(0, player.currentTime - 10);
        } else if (e.key === 'l') {
            player.currentTime = Math.min(player.duration, player.currentTime + 10);
        } else if (e.key === 'ArrowLeft') {
            player.currentTime = Math.max(0, player.currentTime - 5);
        } else if (e.key === 'ArrowRight') {
            player.currentTime = Math.min(player.duration, player.currentTime + 5);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            player.volume = Math.min(1, player.volume + 0.1);
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            player.volume = Math.max(0, player.volume - 0.1);
        } else if (e.key === 'm') {
            player.muted = !player.muted;
        } else if (e.key === 'f') {
            player.requestFullscreen ? player.requestFullscreen() : null;
        }
        return;
    }
    
    // Video grid navigation
    const activeTab = document.querySelector('.tab-content.active');
    if (activeTab && activeTab.id === 'tab-videos' && videos.length > 0) {
        if (e.key === 'ArrowRight') {
            e.preventDefault();
            const idx = currentVideo ? videos.findIndex(v => v.id === currentVideo.id) : -1;
            const nextIdx = Math.min(videos.length - 1, idx + 1);
            if (nextIdx >= 0) openVideoModal(nextIdx);
        } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            const idx = currentVideo ? videos.findIndex(v => v.id === currentVideo.id) : videos.length;
            const prevIdx = Math.max(0, idx - 1);
            openVideoModal(prevIdx);
        } else if (e.key === 'Enter' && videos.length > 0) {
            openVideoModal(0);
        }
    }
});

document.addEventListener('DOMContentLoaded', async () => {
    const loadingScreen = document.getElementById('loading-screen');
    const loginScreen = document.getElementById('login-screen');
    
    // Fetch and display version, check login status
    try {
        const r = await fetch('/api/status');
        const data = await r.json();
        const verEl = document.getElementById('app-version');
        if (verEl && data.version) {
            verEl.textContent = 'v' + data.version;
        }
        // Update About section
        const aboutVerEl = document.getElementById('about-version');
        if (aboutVerEl && data.version) {
            aboutVerEl.textContent = 'v' + data.version;
        }
        const aboutBuildEl = document.getElementById('about-build-date');
        if (aboutBuildEl && data.build_date) {
            const buildDate = new Date(data.build_date);
            aboutBuildEl.textContent = 'Build: ' + buildDate.toLocaleDateString('en-US', {year:'numeric', month:'long', day:'numeric'});
        }
        
        // If already logged in (status shows cameras), show the app directly
        if (data.logged_in && data.camera_count > 0) {
            loadingScreen.classList.add('hidden');
            showApp();
            // Restore last section from localStorage
            const lastSection = localStorage.getItem('lastSection');
            if (lastSection) {
                switchTab(lastSection);
            }
        } else {
            // Try auto-login with saved credentials
            tryAutoLogin();
        }
    } catch (e) {
        const verEl = document.getElementById('app-version');
        if (verEl) verEl.textContent = 'v3.1.0';
        // Try auto-login anyway
        tryAutoLogin();
    }
    
    // Restore camera grid size preference
    const camGridEl = document.getElementById('cam-grid-size');
    if (camGridEl) {
        const savedCamGrid = localStorage.getItem('cameraGridSize');
        if (savedCamGrid) {
            cameraGridSize = parseInt(savedCamGrid);
            camGridEl.value = savedCamGrid;
        }
    }
    
    // Restore sync grid size preference
    const syncGridEl = document.getElementById('sync-grid-size');
    if (syncGridEl) {
        const savedSyncGrid = localStorage.getItem('syncGridSize');
        if (savedSyncGrid) {
            syncGridSize = parseInt(savedSyncGrid);
            syncGridEl.value = savedSyncGrid;
        }
    }
    
    // Restore video grid size preference
    const vidGridEl = document.getElementById('vid-grid-size');
    if (vidGridEl) {
        const savedVidGrid = localStorage.getItem('videoGridSize');
        if (savedVidGrid) {
            videoGridSize = parseInt(savedVidGrid);
            vidGridEl.value = savedVidGrid;
        }
    }
});

async function tryAutoLogin() {
    const loadingScreen = document.getElementById('loading-screen');
    const loginScreen = document.getElementById('login-screen');
    
    try {
        const r = await fetch('/api/login/saved', {method: 'POST'});
        const d = await r.json();
        
        if (d.success) {
            loadingScreen.classList.add('hidden');
            showApp();
            // Restore last section from localStorage
            const lastSection = localStorage.getItem('lastSection');
            if (lastSection) {
                switchTab(lastSection);
            }
        } else {
            // Show login screen
            loadingScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }
    } catch (e) {
        // Show login screen on error
        loadingScreen.classList.add('hidden');
        loginScreen.classList.remove('hidden');
    }
}
    </script>
</body>
</html>
